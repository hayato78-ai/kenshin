# CDmedical 健診システム アーキテクチャ設計書

> **バージョン**: 1.0
> **作成日**: 2025-12-29
> **ステータス**: マスタードキュメント

---

## 1. システム概要

### 1.1 目的

CDmedical健診システムは、健康診断結果の入力・管理・帳票出力を効率化するWebアプリケーションです。

### 1.2 技術スタック

| 層 | 技術 | 役割 |
|----|------|------|
| フロントエンド | HTML/CSS/JavaScript | Web UI（タブ形式） |
| バックエンド | Google Apps Script (GAS) | API・ビジネスロジック |
| データベース | Google Sheets | データ永続化 |
| 帳票出力 | Python + openpyxl | Excel転記 |
| AI連携 | Claude API | 保健指導生成・CSVマッピング推定 |

### 1.3 アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────┐
│                    ブラウザ（Web UI）                        │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐           │
│  │ 受診者  │ │ 検査結果│ │ 帳票出力│ │ マスタ  │           │
│  │ タブ    │ │ タブ    │ │ タブ    │ │ タブ    │           │
│  └────┬────┘ └────┬────┘ └────┬────┘ └────┬────┘           │
│       └───────────┴───────────┴───────────┘                 │
│                           │                                 │
│                  google.script.run                          │
└───────────────────────────┼─────────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────────┐
│                  Google Apps Script                            │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐           │
│  │ portalApi.js │ │ CRUD.js      │ │ Config.js    │           │
│  │ (API層)      │ │ (データ層)    │ │ (設定)       │           │
│  └──────┬───────┘ └──────┬───────┘ └──────────────┘           │
│         │                │                                     │
│  ┌──────┴────────────────┴──────────────────────────────┐     │
│  │ judgmentEngine.js │ csvImport.js │ billingManager.js│     │
│  │ (判定エンジン)      │ (CSV取込)    │ (請求管理)       │     │
│  └──────────────────────────────────────────────────────┘     │
│         │                                                      │
│  ┌──────┴──────────────────────────────────────────────────┐  │
│  │ excelExportBridge.js ←→ JSON ←→ Python unified_transcriber│ │
│  └─────────────────────────────────────────────────────────┘  │
└───────────────────────────┬───────────────────────────────────┘
                            ↓
┌───────────────────────────────────────────────────────────────┐
│                  Google Sheets（データベース）                  │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐              │
│  │ T_受診者    │ │ T_受診記録  │ │ 検査結果    │              │
│  │ T_所見      │ │ M_検査項目  │ │ M_団体      │              │
│  └─────────────┘ └─────────────┘ └─────────────┘              │
└───────────────────────────────────────────────────────────────┘
```

---

## 2. モジュール構成

### 2.1 GASファイル一覧

詳細は `docs/FUNCTION_INVENTORY.md` を参照。

| ファイル | 役割 | 主要関数 |
|----------|------|----------|
| portal.js | Webアプリエントリーポイント | doGet() |
| portalApi.js | フロントエンドAPI | portalSearchPatients(), portalGetPatientDetail() |
| CRUD.js | 汎用CRUD操作 | create(), read(), update(), delete() |
| Config.js | 設定・定数 | DB_CONFIG, SHEETS, COLUMNS |
| judgmentEngine.js | 判定エンジン | autoJudge(), calculateOverallJudgment() |
| csvImport.js | CSV取込 | parseBmlCsv(), importCsvToSheet() |
| excelExportBridge.js | Python連携 | exportIndividualReport(), checkExportStatus() |
| billingManager.js | 請求管理 | getBillingList(), calculateBilling() |
| master_examItem.js | 検査項目マスタ | getExamItems(), updateExamItem() |

### 2.2 Pythonファイル一覧

| ファイル | 役割 |
|----------|------|
| unified_transcriber.py | Excel転記エンジン（労災・人間ドック対応） |
| drive_watcher.py | Google Driveフォルダ監視（ポーリング） |
| settings.yaml | 設定ファイル |

---

## 3. データ構造

**正式なデータ構造定義は `設計書_設定ファイル/1220_new/DATA_STRUCTURE_DESIGN_v2.md` を参照してください。**

### 3.1 シート一覧（概要）

| シート名 | 説明 | データ形式 |
|----------|------|------------|
| T_受診者 | 受診者基本情報 | 1行=1受診者 |
| T_受診記録 | 受診ごとの情報 | 1行=1受診 |
| 検査結果 | 検査結果 | **横持ち**（1行=1患者、101列） |
| T_所見 | 所見データ | 縦持ち（1行=1項目の所見） |
| M_検査項目 | 検査項目マスタ | 46列構造 |
| M_団体 | 企業・団体マスタ | 1行=1企業 |

### 3.2 判定区分（統一基準）

| 判定 | 名称 | 優先度 |
|------|------|--------|
| A | 異常なし | 6（最低） |
| B | 軽度異常 | 5 |
| C | 要経過観察 | 4 |
| D | 要精密検査 | 3 |
| E | 要治療 | 2 |
| F | 治療中 | 1（最高） |
| * | 判定不可 | - |

---

## 4. Excel出力システム

### 4.1 処理フロー

```
[Web UI] → JSON生成 → pending/ → [Python監視] → Excel生成 → output/
```

### 4.2 フォルダ構成

| フォルダ | 用途 |
|---------|------|
| pending/ | リクエストJSON待機 |
| processed/ | 処理完了JSON |
| error/ | エラー発生時 |
| output/ | 生成Excel |

### 4.3 起動コマンド

```bash
cd python
python3 unified_transcriber.py --watch
```

---

## 5. 開発ルール

### 5.1 ファイル編集フロー

```
ローカル編集 → clasp push → 動作確認 → clasp deploy
```

### 5.2 禁止事項

- GASエディタでの直接編集
- templates/ 以外へのHTML作成
- doGet() 関数の無断変更

### 5.3 Git運用

- mainブランチで直接作業OK
- 機能単位でコミット
- コミットメッセージ: `feat:`, `fix:`, `refactor:` プレフィックス使用

---

## 6. ドキュメント体系

### 6.1 正式ドキュメント

| ファイル | 役割 |
|----------|------|
| CLAUDE.md | プロジェクトルール（エントリーポイント） |
| docs/ARCHITECTURE.md | アーキテクチャ設計書（本ドキュメント） |
| docs/FUNCTION_INVENTORY.md | 機能棚卸し表 |
| docs/cross-cutting-concerns.md | 横断的ナレッジ |
| 設計書_設定ファイル/1220_new/DATA_STRUCTURE_DESIGN_v2.md | データ構造設計書 |

### 6.2 アーカイブ済み

旧設計書は `docs/archive/` に移動済み。参照のみ可。

---

## 7. 機能移植判定サマリー

詳細は `docs/FUNCTION_INVENTORY.md` を参照。

| 判定 | 機能数 | 説明 |
|------|--------|------|
| ○ 移植 | 43 | 移植対象 |
| △ 検討 | 9 | 労災専用・開発中 |
| × 不要 | 1 | F011 GAS native Excel（Python版に統一） |

---

## 変更履歴

| 日付 | Ver | 内容 |
|------|-----|------|
| 2025-12-29 | 1.0 | 初版作成（旧設計書を統合） |
