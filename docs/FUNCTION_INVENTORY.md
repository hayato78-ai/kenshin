# 機能棚卸し表

**作成日**: 2025-12-29
**目的**: 大規模改修にあたり、既存機能を整理して「移植する/しない」を判断するための棚卸し

---

## 凡例

### 使用状況
| 記号 | 意味 |
|------|------|
| 使用中 | 本番運用で使用されている |
| 開発中 | 実装途中または一部機能のみ |
| 未使用 | 実装済みだが使用されていない |
| 要確認 | 使用状況が不明 |

### 移植判定
| 記号 | 意味 |
|------|------|
| ○ | 移植する |
| △ | 検討が必要 |
| × | 不要（削除可） |
| （空欄） | 未判定 |

---

## 1. CSV取込

BML検査結果CSV・汎用CSVの取込・解析機能

| 機能ID | 機能名 | 概要 | 使用状況 | 関連ファイル | 依存関係 | 移植判定 | 備考 |
|--------|--------|------|----------|--------------|----------|----------|------|
| F001 | BML CSV解析 | BML検査コード形式CSVの解析。エンコーディング自動検出（Shift-JIS/CP932/UTF-8） | 使用中 | gas/csvImport.js, python/common/parser.py | F003 | ○ | GAS版とPython版が並存 |
| F002 | 汎用CSV解析 | 列ヘッダーベースの汎用CSVマッピング | 開発中 | gas/csvImport.js | - | ○ | AIマッピング推定機能あり |
| F003 | CSV列マッピング推定 | Claude APIを使用した列マッピングの自動推定 | 開発中 | gas/csvImport.js, gas/claudeApi.js | F042 | ○ | AIマッピングUI含む |
| F004 | CSVデータ検証 | 値範囲チェック、必須項目チェック | 使用中 | gas/csvImport.js | - | ○ | |
| F005 | CSV取込UI | CSVアップロードダイアログ、プレビュー表示 | 使用中 | gas/csvImport.js, gas/templates/portal.html | F001 | ○ | |

---

## 2. 判定エンジン

検査値に対する判定（A〜F）の自動算出

| 機能ID | 機能名 | 概要 | 使用状況 | 関連ファイル | 依存関係 | 移植判定 | 備考 |
|--------|--------|------|----------|--------------|----------|----------|------|
| F006 | 単項目判定 | 検査項目ごとの基準値判定（性別別対応） | 使用中 | gas/judgmentEngine.js | F030 | ○ | マスタ参照 |
| F007 | 複合判定（血圧） | 収縮期・拡張期の組み合わせ判定 | 使用中 | gas/judgmentEngine.js | F006 | ○ | |
| F008 | 複合判定（糖代謝） | 空腹時血糖・HbA1cの組み合わせ判定 | 使用中 | gas/judgmentEngine.js | F006 | ○ | |
| F009 | 総合判定 | 全検査項目の最重判定を算出 | 使用中 | gas/judgmentEngine.js | F006, F007, F008 | ○ | |
| F010 | Python判定エンジン | Python側での判定ロジック（Excel出力用） | 使用中 | python/common/judgment.py | - | ○ | 人間ドック学会2025基準 |

---

## 3. Excel出力

検査結果のExcel帳票出力機能

| 機能ID | 機能名 | 概要 | 使用状況 | 関連ファイル | 依存関係 | 移植判定 | 備考 |
|--------|--------|------|----------|--------------|----------|----------|------|
| F011 | GAS native Excel出力 | SpreadsheetApp経由のExcel生成 | 要確認 | gas/excelExporter.js | F020 | × | Python版に統一 |
| F012 | Python Excel出力（労災） | 労災二次検診用Excel転記（iD-Heart形式） | 使用中 | python/unified_transcriber.py | - | ○ | RosaiTranscriber |
| F013 | Python Excel出力（人間ドック） | 人間ドック用Excel転記（マッピングベース） | 使用中 | python/unified_transcriber.py | F010 | ○ | HumanDockTranscriber |
| F014 | ポーリング監視 | pendingフォルダを5秒間隔で監視 | 使用中 | python/drive_watcher.py | F012, F013 | ○ | Google Drive対応 |
| F015 | GAS-Python連携 | JSON生成→pending配置→結果取得 | 使用中 | gas/excelExportBridge.js | F014 | ○ | 自動ダウンロード機能 |
| F016 | 一括Excel出力 | 複数患者の一括Excel出力 | 使用中 | gas/excelExportBridge.js | F015 | ○ | |

---

## 4. ポータルUI

Webアプリのユーザーインターフェース

| 機能ID | 機能名 | 概要 | 使用状況 | 関連ファイル | 依存関係 | 移植判定 | 備考 |
|--------|--------|------|----------|--------------|----------|----------|------|
| F017 | Webアプリエントリーポイント | doGet()によるHTML返却 | 使用中 | gas/portal.js | - | ○ | |
| F018 | タブ形式UI | 機能別タブ切り替え | 使用中 | gas/templates/portal.html, js.html | - | ○ | 受診者/検査結果/請求等 |
| F019 | スタイル定義 | CSS定義 | 使用中 | gas/templates/css.html | - | ○ | |
| F020 | フロントエンドAPI呼び出し | google.script.runによるAPI呼び出し | 使用中 | gas/templates/js.html | F024 | ○ | |

---

## 5. 受診者管理

受診者データのCRUD・検索機能

| 機能ID | 機能名 | 概要 | 使用状況 | 関連ファイル | 依存関係 | 移植判定 | 備考 |
|--------|--------|------|----------|--------------|----------|----------|------|
| F021 | 受診者検索 | 氏名・カルテNo・受診日での検索 | 使用中 | gas/portalApi.js, patientManager.js | - | ○ | カナ正規化対応 |
| F022 | 受診者登録 | 新規受診者の登録 | 使用中 | gas/portalApi.js, CRUD.js | - | ○ | ID自動採番 |
| F023 | 受診者更新 | 受診者情報の更新 | 使用中 | gas/portalApi.js, PatientService.js | F022 | ○ | ステータス遷移管理 |
| F024 | 受診者詳細取得 | 患者情報+検査結果の統合取得 | 使用中 | gas/patientManager.js | - | ○ | 複数シート横串検索 |
| F025 | 進捗管理 | 受診者ごとの進捗ステータス管理 | 開発中 | gas/portalApi.js | - | ○ | 完了/途中/未 |

---

## 6. 請求管理

企業別・個人別の請求管理機能

| 機能ID | 機能名 | 概要 | 使用状況 | 関連ファイル | 依存関係 | 移植判定 | 備考 |
|--------|--------|------|----------|--------------|----------|----------|------|
| F026 | 請求一覧取得 | 企業別に請求データを集計 | 開発中 | gas/billingManager.js | F031 | △ | WebApp統合未完了 |
| F027 | 請求金額計算 | コース・オプションに基づく金額計算 | 開発中 | gas/billingManager.js | F032 | △ | 未実装関数あり |
| F028 | 請求ステータス管理 | 未請求/請求中/請求済みの状態管理 | 開発中 | gas/billingManager.js | F026 | △ | ダイアログのみ |

---

## 7. 保健指導

Claude AIを活用した保健指導文生成

| 機能ID | 機能名 | 概要 | 使用状況 | 関連ファイル | 依存関係 | 移植判定 | 備考 |
|--------|--------|------|----------|--------------|----------|----------|------|
| F029 | 保健指導質問票入力 | 就労状況・生活習慣等の入力UI | 使用中 | gas/guidanceInput.js | - | ○ | 労災二次検診向け |
| F030 | Claude AI保健指導生成 | 検査結果+質問票から保健指導文を自動生成 | 使用中 | gas/guidanceInput.js, claudeApi.js | F042 | ○ | |
| F031 | 会社マスタ管理 | 企業・会社情報の管理 | 使用中 | gas/guidanceInput.js | - | ○ | キャッシング対応 |

---

## 8. マスタ管理

各種マスタデータの管理機能

| 機能ID | 機能名 | 概要 | 使用状況 | 関連ファイル | 依存関係 | 移植判定 | 備考 |
|--------|--------|------|----------|--------------|----------|----------|------|
| F032 | 検査項目マスタ管理 | M_検査項目シートのCRUD（46列構造） | 使用中 | gas/master_examItem.js | - | ○ | 判定基準含む |
| F033 | 判定基準キャッシュ | マスタデータのメモリキャッシュ | 使用中 | gas/MasterData.js | F032 | ○ | パフォーマンス向上 |
| F034 | 組織マスタ管理 | 健康保険→事業所→企業→コースの階層管理 | 使用中 | gas/organizationMaster.js | - | ○ | |
| F035 | コース管理 | 健診コースとコース別検査項目の管理 | 開発中 | gas/organizationMaster.js | F032 | ○ | |
| F036 | DB初期化 | スプレッドシートのスキーマ定義・初期化 | 使用中 | gas/SetupDB.js | - | ○ | マスタデータ挿入含む |

---

## 9. 労災二次検診

労災二次検診特化の機能

| 機能ID | 機能名 | 概要 | 使用状況 | 関連ファイル | 依存関係 | 移植判定 | 備考 |
|--------|--------|------|----------|--------------|----------|----------|------|
| F037 | 労災ケース管理 | ケース一覧取得、フォルダ管理 | 使用中 | gas/rosaiSecondary.js | - | △ | 労災専用モジュール |
| F038 | 労災入力シート生成 | 個別入力シートの自動作成 | 使用中 | gas/rosaiSecondary.js | - | △ | 労災専用モジュール |
| F039 | 超音波所見入力 | 心臓・頸動脈の超音波所見テンプレート選択 | 使用中 | gas/rosaiSecondary.js | - | △ | 労災専用モジュール |
| F040 | 労災総合所見生成 | 判定に応じた総合所見の自動生成 | 使用中 | gas/rosaiSecondary.js | F006 | △ | 労災専用モジュール |
| F041 | 労災Excel出力 | 労災専用テンプレートへの転記 | 使用中 | gas/rosaiSecondary.js, python/unified_transcriber.py | F012 | △ | 労災専用モジュール |

---

## 10. 所見・レポート

所見自動生成と帳票出力

| 機能ID | 機能名 | 概要 | 使用状況 | 関連ファイル | 依存関係 | 移植判定 | 備考 |
|--------|--------|------|----------|--------------|----------|----------|------|
| F042 | Claude API連携 | Anthropic API呼び出し基盤 | 使用中 | gas/claudeApi.js | - | ○ | APIキー管理含む |
| F043 | 所見自動生成 | 判定レベル別テンプレートから所見文を生成 | 開発中 | gas/findingsGenerator.js | F006, F032 | △ | カテゴリ別対応 |
| F044 | 所見保存・取得 | T_所見シートへの保存・取得 | 使用中 | gas/findingsGenerator.js | - | ○ | |
| F045 | 企業別レポート生成 | 複数患者データを集計した企業向けレポート | 開発中 | gas/reportExporter.js | F024 | △ | 設計再検討 |
| F046 | 個別レポート生成 | 受診者個別の結果報告書 | 開発中 | gas/reportExporter.js | F024, F006 | △ | 設計再検討 |
| F047 | テンプレート管理 | 出力テンプレートの登録・管理 | 使用中 | gas/templateManager.js | - | ○ | Drive連携 |

---

## 11. 基盤・共通

システム全体で使用される基盤機能

| 機能ID | 機能名 | 概要 | 使用状況 | 関連ファイル | 依存関係 | 移植判定 | 備考 |
|--------|--------|------|----------|--------------|----------|----------|------|
| F048 | 設定管理 | DB設定・定数定義 | 使用中 | gas/Config.js | - | ○ | SHEETS, COLUMNS等 |
| F049 | ユーティリティ | 日付計算、BMI計算、ログ出力等 | 使用中 | gas/utils.js | - | ○ | |
| F050 | 統合CRUD | 受診者・受診記録・検査結果の汎用CRUD | 使用中 | gas/CRUD.js | F048 | ○ | ID自動採番 |
| F051 | UIマッピング | エンティティ⇔UI表示オブジェクト変換 | 使用中 | gas/UIMapping.js | - | ○ | View Model層 |
| F052 | メイン処理・トリガー | バッチ処理、自動トリガー管理 | 使用中 | gas/main.js | 全モジュール | ○ | CSV監視トリガー等 |
| F053 | Python設定管理 | settings.yaml による設定管理 | 使用中 | python/settings.yaml | - | ○ | クロスプラットフォーム対応 |

---

## 依存関係図

```
┌─────────────────────────────────────────────────────────────┐
│                       基盤・共通                             │
│  F048 Config.js ─→ F049 utils.js ─→ F050 CRUD.js           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      マスタ管理                              │
│  F032 検査項目マスタ ─→ F033 キャッシュ ─→ F006 判定エンジン │
│  F034 組織マスタ ─→ F035 コース管理                         │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      データ入力                              │
│  F001 CSV取込 ─→ F021 受診者登録 ─→ F024 詳細取得           │
│  F029 保健指導入力 ─→ F030 AI生成                           │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      判定・所見                              │
│  F006〜F009 判定エンジン ─→ F043 所見自動生成               │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      出力                                    │
│  F011〜F016 Excel出力 ─→ F045〜F046 レポート生成            │
│  F037〜F041 労災専用 ─→ F012 労災Excel出力                  │
└─────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│                      UI                                      │
│  F017〜F020 ポータルUI ─→ F026〜F028 請求管理               │
└─────────────────────────────────────────────────────────────┘
```

---

## 機能数サマリー

| カテゴリ | 機能数 | 使用中 | 開発中 | 未使用 | 要確認 |
|---------|-------|-------|-------|-------|-------|
| 1. CSV取込 | 5 | 3 | 2 | 0 | 0 |
| 2. 判定エンジン | 5 | 5 | 0 | 0 | 0 |
| 3. Excel出力 | 6 | 5 | 0 | 0 | 1 |
| 4. ポータルUI | 4 | 4 | 0 | 0 | 0 |
| 5. 受診者管理 | 5 | 4 | 1 | 0 | 0 |
| 6. 請求管理 | 3 | 0 | 3 | 0 | 0 |
| 7. 保健指導 | 3 | 3 | 0 | 0 | 0 |
| 8. マスタ管理 | 5 | 4 | 1 | 0 | 0 |
| 9. 労災二次検診 | 5 | 5 | 0 | 0 | 0 |
| 10. 所見・レポート | 6 | 3 | 3 | 0 | 0 |
| 11. 基盤・共通 | 6 | 6 | 0 | 0 | 0 |
| **合計** | **53** | **42** | **10** | **0** | **1** |

---

## 移植優先度の参考情報

### 優先度高（コア機能）
- F001〜F005: CSV取込（BML対応必須）
- F006〜F010: 判定エンジン（ビジネスロジックの中核）
- F021〜F025: 受診者管理（基本CRUD）
- F048〜F052: 基盤・共通（全機能が依存）

### 優先度中（運用機能）
- F011〜F016: Excel出力（実運用で使用）
- F029〜F031: 保健指導（AI連携）
- F032〜F036: マスタ管理（データ基盤）
- F043〜F047: 所見・レポート（出力系）

### 優先度低（特化機能）
- F037〜F041: 労災二次検診（労災専用）
- F026〜F028: 請求管理（開発中）

### 検討が必要
- F011: GAS native Excel出力（Python版と重複）
- F002〜F003: 汎用CSVマッピング（開発途中）
