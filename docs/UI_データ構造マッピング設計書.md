# UI・データ構造マッピング設計書

CDmedical 健診結果管理システム ポータルUI v1.0.0

---

## 1. 概要

本設計書は、WebアプリポータルのUI要素とスプレッドシートのデータ構造を対応付け、
UIを変更した際にデータ構造も同期して更新できるよう定義したものです。

---

## 2. スプレッドシート構造

### 2.1 受診者マスタシート

| 列番号 | 列名 | データ型 | 説明 |
|--------|------|----------|------|
| 0 | 受診ID | String | 一意の識別子（主キー） |
| 1 | ステータス | String | 入力中/完了/キャンセル |
| 2 | 受診日 | Date | 受診した日付 |
| 3 | 氏名 | String | 姓＋名（スペース区切り） |
| 4 | カナ | String | セイ＋メイ（スペース区切り） |
| 5 | 性別 | String | 男/女 |
| 6 | 生年月日 | Date | 生年月日 |
| 7 | 年齢 | Number | 自動計算される年齢 |
| 8 | 受診コース | String | 人間ドック/定期健診/等 |
| 9 | 事業所名 | String | 所属企業名 |
| 10 | 所属 | String | 部署名 |
| 11 | 総合判定 | String | A/B/C/D/E/G |
| 12 | CSV取込日時 | DateTime | CSV取込した日時 |
| 13 | 最終更新日時 | DateTime | 最終更新日時 |
| 14 | 出力日時 | DateTime | 帳票出力した日時 |

---

## 3. UIフィールドマッピング

### 3.1 受診者登録フォーム

```
┌─────────────────────────────────────────────────────────────┐
│ 新規受診者登録                                               │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [受診ID] ──────────────────────────→ 受診者マスタ.受診ID    │
│                                                             │
│  [姓] + [名] ────────────────────────→ 受診者マスタ.氏名     │
│   ※ 半角スペースで結合: "山田 太郎"                          │
│                                                             │
│  [セイ] + [メイ] ────────────────────→ 受診者マスタ.カナ     │
│   ※ 半角スペースで結合: "ヤマダ タロウ"                      │
│                                                             │
│  [生年月日] ─────────────────────────→ 受診者マスタ.生年月日 │
│                                       → 受診者マスタ.年齢    │
│   ※ 年齢は自動計算                    （自動計算）           │
│                                                             │
│  [性別] ─────────────────────────────→ 受診者マスタ.性別     │
│                                                             │
│  [受診コース] ───────────────────────→ 受診者マスタ.受診コース │
│                                                             │
│  [受診日] ───────────────────────────→ 受診者マスタ.受診日   │
│                                                             │
│  [事業所名] ─────────────────────────→ 受診者マスタ.事業所名 │
│                                                             │
│  ステータス: "入力中" ───────────────→ 受診者マスタ.ステータス │
│   ※ 新規登録時は自動設定                                     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 UIフィールド詳細

| UI要素ID | ラベル | 入力形式 | 必須 | 保存先列 | 変換処理 |
|----------|--------|----------|------|----------|----------|
| newPatientId | 受診ID | text | ✅ | 受診ID | なし |
| newPatientLastName | 姓 | text | ✅ | 氏名 | 姓＋" "＋名 |
| newPatientFirstName | 名 | text | ✅ | 氏名 | 姓＋" "＋名 |
| newPatientLastNameKana | セイ | text | ✅ | カナ | セイ＋" "＋メイ |
| newPatientFirstNameKana | メイ | text | ✅ | カナ | セイ＋" "＋メイ |
| newPatientBirthDate | 生年月日 | date | - | 生年月日 | なし |
| newPatientGender | 性別 | select | - | 性別 | なし |
| newPatientCourse | 受診コース | select | - | 受診コース | デフォルト:人間ドック |
| newPatientExamDate | 受診日 | date | - | 受診日 | デフォルト:今日 |
| newPatientCompany | 事業所名 | text | - | 事業所名 | なし |

---

## 4. 検索機能仕様

### 4.1 検索フロー

```
┌──────────────────────────────────────────────────────────────────┐
│ ユーザー入力                                                      │
│   受診ID: [P001   ]                                              │
│   氏名:   [田中　太郎]  ← 全角スペース                             │
│   カナ:   [ﾀﾅｶ ﾀﾛｳ]    ← 半角カナ                                │
│                        [検索] ボタン                              │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│ フロントエンド (js.html)                                         │
│ searchPatients() 関数                                            │
│                                                                  │
│ criteria = {                                                     │
│   patientId: "P001",                                             │
│   name: "田中　太郎",    // 入力そのまま                          │
│   kana: "ﾀﾅｶ ﾀﾛｳ"       // 入力そのまま                          │
│ }                                                                │
│                                                                  │
│ google.script.run.portalSearchPatients(criteria)                 │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│ バックエンド (portalApi.gs)                                      │
│ portalSearchPatients(criteria) 関数                              │
│                                                                  │
│ 【正規化処理】                                                   │
│                                                                  │
│ searchId = normalizeString("P001")                               │
│          → "p001" (小文字化)                                     │
│                                                                  │
│ searchName = normalizeString("田中　太郎")                       │
│            → "田中 太郎" (全角スペース→半角、小文字化)           │
│                                                                  │
│ searchKana = normalizeKana("ﾀﾅｶ ﾀﾛｳ")                           │
│            → "タナカ タロウ" (半角カナ→全角カナ)                 │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│ スプレッドシート検索                                             │
│                                                                  │
│ 各行のデータも正規化して比較:                                    │
│                                                                  │
│ row[0] = "P00001"                                                │
│   → normalizeString("P00001") = "p00001"                         │
│   → "p00001".includes("p001") = true ✅                          │
│                                                                  │
│ row[3] = "田中　太郎"                                            │
│   → normalizeString("田中　太郎") = "田中 太郎"                  │
│   → "田中 太郎".includes("田中 太郎") = true ✅                  │
│                                                                  │
│ row[4] = "タナカ　タロウ"                                        │
│   → normalizeKana("タナカ　タロウ") = "タナカ タロウ"            │
│   → "タナカ タロウ".includes("タナカ タロウ") = true ✅          │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│ 検索結果オブジェクト                                             │
│                                                                  │
│ {                                                                │
│   success: true,                                                 │
│   data: [{                                                       │
│     "受診ID": "P00001",                                          │
│     "ステータス": "入力中",                                      │
│     "受診日": "2025-01-15",                                      │
│     "氏名": "田中　太郎",                                        │
│     "カナ": "タナカ　タロウ",                                    │
│     "性別": "男",                                                │
│     "生年月日": "1980-05-20",                                    │
│     "年齢": 44,                                                  │
│     "受診コース": "人間ドック",                                  │
│     "事業所名": "株式会社ABC",                                   │
│     "所属": "営業部",                                            │
│     "総合判定": "",                                              │
│     _rowIndex: 2                                                 │
│   }],                                                            │
│   count: 1                                                       │
│ }                                                                │
└──────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌──────────────────────────────────────────────────────────────────┐
│ フロントエンド表示 (js.html)                                     │
│ displayPatientSearchResults(result) 関数                         │
│                                                                  │
│ ┌────────────────────────────────────────────────────────────┐   │
│ │ 受診ID  │ 氏名      │ カナ        │ 受診日    │ 操作      │   │
│ ├─────────┼───────────┼─────────────┼───────────┼───────────┤   │
│ │ P00001  │ 田中 太郎 │ タナカ タロウ│ 2025/1/15 │ [結果入力]│   │
│ └────────────────────────────────────────────────────────────┘   │
│                                                                  │
│ 【結果入力】ボタンクリック時:                                    │
│   selectPatientForInput("P00001")                                │
│     → 結果入力セクションに遷移                                   │
│     → 患者情報ヘッダーに詳細表示                                 │
│     → 身体計測タブを表示                                         │
└──────────────────────────────────────────────────────────────────┘
```

### 4.2 正規化関数仕様

#### normalizeString(str)
```javascript
// 入力: 任意の文字列
// 出力: 正規化された文字列

処理内容:
1. null/undefined → 空文字列
2. 全角スペース(　) → 半角スペース( )
3. 連続スペース → 単一スペース
4. 前後の空白を除去
5. 小文字に変換

例:
  "田中　太郎"     → "田中 太郎"
  "  P001  "       → "p001"
  "YAMADA　Taro"   → "yamada taro"
```

#### normalizeKana(str)
```javascript
// 入力: カナ文字列
// 出力: 全角カナに統一された文字列

処理内容:
1. スペースを正規化（normalizeStringと同様）
2. 半角カナ → 全角カナ変換

例:
  "ﾀﾅｶ ﾀﾛｳ"       → "タナカ タロウ"
  "ヤマダ　ハナコ"  → "ヤマダ ハナコ"
```

### 4.3 検索結果からの画面遷移

```
検索結果テーブル
      │
      │ [結果入力] ボタンクリック
      ▼
selectPatientForInput(patientId)
      │
      ├─→ currentPatientId = patientId (グローバル変数に保存)
      │
      ├─→ showSection('results') (結果入力セクションに切替)
      │
      └─→ loadPatientForResults(patientId)
              │
              ├─→ portalGetPatient(patientId)
              │     → 患者基本情報を取得
              │     → displayPatientHeader() でヘッダー表示
              │
              └─→ portalGetBloodTestResults(patientId)
                    → 血液検査結果を取得
                    → displayBloodTestResults() で表示
                    → populateMeasurementForm() でフォームに反映

【表示される画面】
┌──────────────────────────────────────────────────────────────┐
│ 結果入力                                                     │
├──────────────────────────────────────────────────────────────┤
│ [検索: _____] [検索]   [← 前へ] P00001 田中 太郎 [次へ →]   │
├──────────────────────────────────────────────────────────────┤
│ ┌──────────────────────────────────────────────────────────┐ │
│ │ ID: P00001  田中 太郎  1980/05/20  男  44歳              │ │
│ │ [血液: ✅] [身体計測: ⬜] [所見: ⬜]                      │ │
│ └──────────────────────────────────────────────────────────┘ │
│                                                              │
│ [血液検査] [身体計測] [所見入力]  ← タブ切替                 │
│                                                              │
│ 《身体計測フォーム》                                         │
│ ┌─基本測定──────────────┐ ┌─血圧・脈拍────────────┐         │
│ │ 身長: [___] cm         │ │ 収縮期: [___] mmHg    │         │
│ │ 体重: [___] kg         │ │ 拡張期: [___] mmHg    │         │
│ │ BMI:  [___] (自動計算) │ │ 脈拍:   [___] /分     │         │
│ └────────────────────────┘ └───────────────────────┘         │
│                                                              │
│                           [保存] [保存して次へ]              │
└──────────────────────────────────────────────────────────────┘
```

---

## 5. データ変更時の同期ルール

### 5.1 UIを変更した場合

| 変更内容 | 必要な対応 |
|----------|------------|
| フィールド追加 | 1. スプレッドシートに列追加<br>2. portalApi.gs の該当関数を更新<br>3. js.html の該当関数を更新 |
| フィールド削除 | 1. js.html から要素削除<br>2. portalApi.gs から参照削除<br>3. スプレッドシート列は残す（後方互換） |
| フィールド名変更 | 1. UI要素のlabel変更<br>2. portalApi.gs のマッピング確認<br>3. スプレッドシート列名は変更しない |
| 入力形式変更 | 1. portal.html の input type 変更<br>2. js.html のバリデーション更新<br>3. portalApi.gs の変換処理確認 |

### 5.2 スプレッドシート列を変更した場合

| 変更内容 | 必要な対応 |
|----------|------------|
| 列追加 | 1. portalApi.gs の列インデックスコメント更新<br>2. 必要に応じてUIフィールド追加 |
| 列削除 | 1. 列インデックスが変わるため全関数の確認必須<br>2. **推奨**: 列は削除せず非表示に |
| 列順変更 | 1. portalApi.gs の列インデックス全更新<br>2. **推奨**: 列順は変更しない |
| 列名変更 | 1. portalApi.gs の結果オブジェクトキー更新<br>2. js.html の参照キー更新 |

---

## 6. 関連ファイル一覧

| ファイル | 役割 |
|----------|------|
| portal.gs | Webアプリエントリーポイント（doGet） |
| portalApi.gs | バックエンドAPI関数群 |
| templates/portal.html | メインHTML構造 |
| templates/css.html | スタイルシート |
| templates/js.html | フロントエンドJavaScript |

---

## 7. バージョン履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0.0 | 2025-12-16 | 初版作成 |

---

## 8. 注意事項

1. **スプレッドシートの列順は変更しない**
   - 列インデックスでアクセスしているため、順序変更は全コードに影響

2. **列は削除ではなく非表示に**
   - 過去データの互換性を維持

3. **氏名・カナは結合形式で保存**
   - UI上は分割（姓/名、セイ/メイ）
   - 保存時は半角スペースで結合

4. **検索は部分一致**
   - 前方一致ではなく、含まれていれば一致
   - 大文字小文字、全角半角は正規化して比較
