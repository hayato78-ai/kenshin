# 健診システム 統合ポータル Webアプリ設計書

> 作成日: 2025-12-16
> バージョン: 1.0
> ステータス: 設計中

---

## 1. 概要

### 1.1 目的

スプレッドシートを意識せずに健診業務を完結できる**統合Webポータル**を提供する。

### 1.2 現状の課題

| 課題 | 詳細 |
|------|------|
| 操作の分散 | 機能ごとにメニュー→ダイアログを繰り返す |
| スプレッドシート露出 | ユーザーが生データを直接見てしまう |
| 導線の悪さ | 機能間の移動が煩雑 |

### 1.3 解決策

```
専用URL → 統合ポータル → 全機能にアクセス
              ↓
        スプレッドシートは
        バックエンドとして隠蔽
```

---

## 2. システムアーキテクチャ

### 2.1 全体構成

```
┌─────────────────────────────────────────────────────────┐
│                    ブラウザ                              │
│  ┌─────────────────────────────────────────────────┐   │
│  │           統合ポータル (HTML/CSS/JS)             │   │
│  │  ┌─────┬─────┬─────┬─────┬─────┐               │   │
│  │  │ホーム│受診者│請求 │帳票 │設定 │ ← タブナビ   │   │
│  │  └─────┴─────┴─────┴─────┴─────┘               │   │
│  │  ┌─────────────────────────────────────────┐   │   │
│  │  │                                          │   │   │
│  │  │         コンテンツエリア                  │   │   │
│  │  │                                          │   │   │
│  │  └─────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                           │
                           │ google.script.run
                           ▼
┌─────────────────────────────────────────────────────────┐
│                  Google Apps Script                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ portal.gs    │  │ patientMgr   │  │ billingMgr   │  │
│  │ (エントリー)  │  │ (受診者管理)  │  │ (請求管理)   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│               Google Spreadsheet (データ層)              │
│  受診者マスタ │ 身体測定 │ 血液検査 │ コースマスタ │ ...│
└─────────────────────────────────────────────────────────┘
```

### 2.2 デプロイ構成

| 項目 | 設定値 |
|------|--------|
| 実行ユーザー | 自分（Me） |
| アクセス権限 | 組織内の全員 / リンクを知っている全員 |
| URL形式 | `https://script.google.com/macros/s/{DEPLOY_ID}/exec` |

---

## 3. 画面設計

### 3.1 画面一覧

| 画面ID | 画面名 | 機能概要 |
|--------|--------|----------|
| SCR-P01 | ダッシュボード | 統計サマリー、クイックアクション |
| SCR-P02 | 受診者管理 | 検索、一覧、新規登録、詳細 |
| SCR-P03 | 請求管理 | 請求一覧、ステータス更新、Excel出力 |
| SCR-P04 | 帳票出力 | 企業別一覧、各種帳票出力 |
| SCR-P05 | 組織マスタ | 企業、コース、保険組合管理 |
| SCR-P06 | 設定 | システム設定、ユーザー設定 |

### 3.2 ダッシュボード (SCR-P01)

```
┌─────────────────────────────────────────────────────────────┐
│ 🏥 CDmedical 健診結果管理システム            田中太郎 ▼    │
├─────────────────────────────────────────────────────────────┤
│ [📋ダッシュボード] [👤受診者] [💰請求] [📊帳票] [🏢組織] [⚙️]│
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐           │
│  │ 📊 今月の   │ │ ⏳ 入力待ち │ │ 💴 未請求   │           │
│  │   受診者数   │ │             │ │             │           │
│  │    125名    │ │    12件     │ │  ¥850,000   │           │
│  └─────────────┘ └─────────────┘ └─────────────┘           │
│                                                             │
│  ┌─ クイックアクション ─────────────────────────────────┐  │
│  │                                                        │  │
│  │  [🔍 受診者検索]  [➕ 新規登録]  [📥 CSV取込]         │  │
│  │                                                        │  │
│  │  [💰 請求一覧]   [📊 帳票出力]  [📋 本日の予定]       │  │
│  │                                                        │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌─ 最近の更新 ─────────────────────────────────────────┐  │
│  │ 12/16 09:00  山田太郎 検査結果入力完了                │  │
│  │ 12/16 08:45  ○○商事 15名分CSV取込                    │  │
│  │ 12/15 17:30  △△工業 請求書発行                       │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 受診者管理 (SCR-P02)

```
┌─────────────────────────────────────────────────────────────┐
│ 🏥 CDmedical 健診結果管理システム            田中太郎 ▼    │
├─────────────────────────────────────────────────────────────┤
│ [📋ダッシュボード] [👤受診者] [💰請求] [📊帳票] [🏢組織] [⚙️]│
├─────────────────────────────────────────────────────────────┤
│ 👤 受診者管理                              [➕ 新規登録]    │
├─────────────────────────────────────────────────────────────┤
│ ┌─ 検索条件 ───────────────────────────────────────────┐   │
│ │ 氏名/カナ [          ] 企業 [▼すべて    ]            │   │
│ │ 期間 [2024/12/01] ～ [2024/12/31]  [🔍検索] [クリア]  │   │
│ └──────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─ 検索結果 (125件) ────────────────────────────────────┐  │
│ │ □ | ID      | 氏名       | 企業     | 受診日   | 判定  │  │
│ │───────────────────────────────────────────────────────│  │
│ │ □ | P00125  | 山田太郎   | ○○商事  | 12/16   | B    │  │
│ │ □ | P00124  | 鈴木花子   | △△工業  | 12/16   | A    │  │
│ │ □ | P00123  | 佐藤一郎   | ○○商事  | 12/15   | C    │  │
│ │                        ...                             │  │
│ └──────────────────────────────────────────────────────┘   │
│                                                             │
│ [◀ 前へ] ページ 1/13 [次へ ▶]    選択: 0件 [一括操作 ▼]   │
└─────────────────────────────────────────────────────────────┘
```

### 3.4 受診者詳細 (SCR-P02-Detail)

```
┌─────────────────────────────────────────────────────────────┐
│ 👤 受診者詳細                    [← 一覧に戻る] [編集] [×] │
├─────────────────────────────────────────────────────────────┤
│ ┌─ 基本情報 ────────────────────────────────────────────┐  │
│ │ 受診ID: P00125        氏名: 山田 太郎                  │  │
│ │ 生年月日: 1980/05/15  性別: 男  年齢: 44歳            │  │
│ │ 企業: ○○商事株式会社  所属: 営業部                   │  │
│ │ 受診日: 2024/12/16    コース: 生活習慣病ドック        │  │
│ │ ステータス: [入力中 ▼]  総合判定: [B]                 │  │
│ └──────────────────────────────────────────────────────┘   │
│                                                             │
│ [📏身体測定] [🩸血液検査] [📝所見] [📄帳票] [履歴]  ← タブ  │
│ ┌──────────────────────────────────────────────────────┐   │
│ │ 身長: 172.5cm  体重: 68.2kg  BMI: 22.9 [A]           │   │
│ │ 血圧: 128/82 mmHg [B]    腹囲: 82.0cm [A]            │   │
│ │ 視力(右): 1.2  視力(左): 1.0                         │   │
│ │ 聴力: 異常なし                                        │   │
│ └──────────────────────────────────────────────────────┘   │
│                                        [保存] [キャンセル]  │
└─────────────────────────────────────────────────────────────┘
```

### 3.5 請求管理 (SCR-P03)

```
┌─────────────────────────────────────────────────────────────┐
│ 💰 請求管理                                                 │
├─────────────────────────────────────────────────────────────┤
│ ┌─ サマリー ────────────────────────────────────────────┐  │
│ │  企業数: 15社  |  総額: ¥3,250,000  |  未請求: ¥850,000 │  │
│ └──────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─ フィルタ ───────────────────────────────────────────┐   │
│ │ 企業 [▼すべて] ステータス [▼すべて] [🔍] [📊Excel出力] │   │
│ └──────────────────────────────────────────────────────┘   │
│                                                             │
│ │ No │ 企業名      │ 人数 │ 金額       │ ステータス │ 操作 │
│ │────────────────────────────────────────────────────────│
│ │ 1  │ ○○商事     │ 25名 │ ¥875,000  │ 未請求     │ [詳細]│
│ │ 2  │ △△工業     │ 12名 │ ¥420,000  │ 請求済     │ [詳細]│
│ │ 3  │ □□製作所   │  8名 │ ¥280,000  │ 入金済     │ [詳細]│
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 技術仕様

### 4.1 ファイル構成

```
gas/
├── portal.gs              # Webアプリエントリーポイント（新規）
├── portalApi.gs           # ポータル用API関数（新規）
├── templates/             # HTMLテンプレート（新規）
│   ├── portal.html        # メインHTML
│   ├── css.html           # スタイルシート
│   ├── js.html            # JavaScript
│   ├── dashboard.html     # ダッシュボード部品
│   ├── patients.html      # 受診者管理部品
│   ├── billing.html       # 請求管理部品
│   ├── reports.html       # 帳票出力部品
│   └── settings.html      # 設定部品
│
├── patientManager.gs      # 既存（流用）
├── billingManager.gs      # 既存（流用）
├── reportExporter.gs      # 既存（流用）
└── ...
```

### 4.2 エントリーポイント (portal.gs)

```javascript
/**
 * Webアプリのエントリーポイント
 * @param {Object} e - イベントオブジェクト
 * @returns {HtmlOutput} HTMLページ
 */
function doGet(e) {
  const template = HtmlService.createTemplateFromFile('templates/portal');

  // 初期データを埋め込み
  template.initialData = JSON.stringify({
    user: Session.getActiveUser().getEmail(),
    dashboard: getDashboardData()
  });

  return template.evaluate()
    .setTitle('CDmedical 健診結果管理システム')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL)
    .addMetaTag('viewport', 'width=device-width, initial-scale=1');
}

/**
 * HTMLファイルをインクルード
 */
function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}
```

### 4.3 API設計 (portalApi.gs)

| 関数名 | 用途 | 引数 | 戻り値 |
|--------|------|------|--------|
| `getDashboardData()` | ダッシュボード用集計 | なし | Object |
| `searchPatientsApi(criteria)` | 受診者検索 | Object | Array |
| `getPatientDetailApi(id)` | 受診者詳細 | String | Object |
| `savePatientApi(data)` | 受診者保存 | Object | Object |
| `getBillingListApi(criteria)` | 請求一覧 | Object | Object |
| `updateBillingStatusApi(ids, status)` | ステータス更新 | Array, String | Object |
| `exportBillingExcelApi(criteria)` | Excel出力 | Object | Object |

### 4.4 フロントエンド技術

| 項目 | 選択 | 理由 |
|------|------|------|
| フレームワーク | Vanilla JS | GAS制約、軽量 |
| CSSフレームワーク | カスタムCSS | 軽量、制御しやすい |
| 状態管理 | シンプルなオブジェクト | 複雑さ回避 |
| ルーティング | ハッシュベース | SPA的動作 |

### 4.5 通信パターン

```javascript
// フロントエンド → バックエンド
google.script.run
  .withSuccessHandler(onSuccess)
  .withFailureHandler(onError)
  .searchPatientsApi(criteria);

// ローディング表示
function callApi(apiName, params, callback) {
  showLoading();
  google.script.run
    .withSuccessHandler((result) => {
      hideLoading();
      callback(null, result);
    })
    .withFailureHandler((error) => {
      hideLoading();
      callback(error, null);
    })
    [apiName](params);
}
```

---

## 5. デプロイ手順

### 5.1 初回デプロイ

1. GASエディタで **デプロイ** → **新しいデプロイ**
2. 種類: **ウェブアプリ**
3. 設定:
   - 説明: `健診システムポータル v1.0`
   - 実行ユーザー: `自分`
   - アクセス権限: `[組織名] の全員` または `全員`
4. **デプロイ** をクリック
5. URLをコピーして共有

### 5.2 更新デプロイ

1. **デプロイ** → **デプロイを管理**
2. 鉛筆アイコン（編集）をクリック
3. バージョン: **新バージョン**
4. **デプロイ** をクリック

### 5.3 URL形式

```
本番URL: https://script.google.com/macros/s/{DEPLOY_ID}/exec
テストURL: https://script.google.com/macros/s/{DEPLOY_ID}/dev
```

---

## 6. セキュリティ

### 6.1 アクセス制御

| レベル | 設定 | 用途 |
|--------|------|------|
| 組織限定 | Google Workspace組織内のみ | 社内システム |
| リンク共有 | URLを知っている人 | 外部委託先含む |

### 6.2 データ保護

- スプレッドシートのアクセス権限は別途管理
- Webアプリは「自分として実行」→ スプレッドシート権限を継承
- ユーザー操作はログに記録（監査証跡）

---

## 7. 実装計画

### Phase 1: 基盤構築（優先）

| タスク | 工数目安 | 成果物 |
|--------|----------|--------|
| portal.gs 作成 | - | エントリーポイント |
| portal.html 作成 | - | メインテンプレート |
| css.html 作成 | - | スタイル定義 |
| js.html 作成 | - | 共通JavaScript |
| デプロイ設定 | - | 動作するWebアプリ |

### Phase 2: 画面実装

| タスク | 依存 | 成果物 |
|--------|------|--------|
| ダッシュボード | Phase 1 | SCR-P01 |
| 受診者管理 | Phase 1 | SCR-P02 |
| 請求管理 | Phase 1 | SCR-P03 |

### Phase 3: 機能拡充

| タスク | 依存 | 成果物 |
|--------|------|--------|
| 帳票出力 | Phase 2 | SCR-P04 |
| 組織マスタ | Phase 2 | SCR-P05 |
| 設定 | Phase 2 | SCR-P06 |

---

## 8. 既存コードの活用

### 8.1 流用可能な関数

| 既存関数 | ファイル | Webアプリでの用途 |
|----------|----------|-------------------|
| `searchPatients()` | patientManager.gs | 受診者検索API |
| `registerNewPatient()` | patientManager.gs | 新規登録API |
| `getPatientDetail()` | patientManager.gs | 詳細取得API |
| `getBillingList()` | billingManager.gs | 請求一覧API |
| `updateBillingStatus()` | billingManager.gs | ステータス更新API |
| `exportBillingToExcel()` | billingManager.gs | Excel出力API |

### 8.2 ラッパー関数の作成

```javascript
// portalApi.gs
function searchPatientsApi(criteria) {
  // 既存関数をラップ
  return searchPatients(criteria);
}

function getBillingListApi(criteria) {
  // 既存関数をラップ
  return getBillingList(criteria);
}
```

---

## 9. 今後の拡張

### 9.1 検討中の機能

- モバイル対応（レスポンシブデザイン）
- プッシュ通知
- オフライン対応（PWA化）
- 外部システム連携API

### 9.2 非機能要件

| 項目 | 目標値 |
|------|--------|
| 初期表示 | 3秒以内 |
| 検索応答 | 2秒以内 |
| 同時アクセス | 10ユーザー |

---

## 付録

### A. 参考リンク

- [Google Apps Script Web Apps](https://developers.google.com/apps-script/guides/web)
- [HtmlService](https://developers.google.com/apps-script/reference/html)

### B. 変更履歴

| 日付 | バージョン | 変更内容 |
|------|------------|----------|
| 2025-12-16 | 1.0 | 初版作成 |
