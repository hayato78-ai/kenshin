# 設計書：データ構造・企業管理

**作成日**: 2025-12-08
**ステータス**: 実装準備完了
**対象システム**: 結果入力GASシステム（保健指導含む）

---

## 1. 企業管理

### 1.1 企業マスタシート設計

```
シート名: 企業マスタ

| 列 | フィールド名 | 型 | 説明 |
|----|------------|-----|------|
| A  | company_id | string | 企業ID（E001形式） |
| B  | company_name | string | 企業名 |
| C  | company_kana | string | 企業名カナ |
| D  | contact_person | string | 担当者名 |
| E  | contact_email | string | 連絡先メール |
| F  | contact_phone | string | 連絡先電話 |
| G  | address | string | 住所 |
| H  | notes | string | 備考 |
| I  | created_at | datetime | 作成日時 |
| J  | updated_at | datetime | 更新日時 |
| K  | is_active | boolean | 有効フラグ |
```

### 1.2 保健指導_データシート追加カラム

```
| 列番号 | フィールド名 | 説明 |
|--------|------------|------|
| 149 | COMPANY_ID | 企業ID（E001形式） |
| 150 | COMPANY_NAME | 企業名（検索用キャッシュ） |
```

### 1.3 企業設定方法

| 健診種別 | 企業設定方法 |
|---------|-------------|
| 労災二次検診 | CSV取り込み時（スケジュールCSVに企業名あり）→自動登録 |
| 人間ドック | 個人ごとに企業設定（※UI未実装） |
| 定期検診 | 個人ごとに企業設定（※UI未実装） |

### 1.4 既存データ
- 後から手動で紐付け

---

## 2. エクセル出力仕様

### 2.1 労災二次検診 A31セル転記

**転記内容**:
- 指導項目（チェックした項目を列挙）
- 生活上の問題点（daily_problem）
- 就労上の問題点（work_problem）

**転記対象フィールド**:

| カテゴリ | フィールド | 表示名 |
|---------|----------|--------|
| 栄養 | g_nutrition_amount | 食事摂取量を適正にする |
| 栄養 | g_nutrition_salt | 食塩・調味料を控える |
| 栄養 | g_nutrition_fiber | 食物繊維を増やす |
| 栄養 | g_nutrition_oil | 油料理を減らす |
| 栄養 | g_meal_time | 食事時間を規則正しく |
| 栄養 | g_nutrition_eating_out | 外食の注意 |
| 栄養 | g_alcohol | 節酒 |
| 栄養 | g_snack | 間食を減らす |
| 栄養 | g_eating_style | 食べ方 |
| 栄養 | g_nutrition_other | その他（栄養） |
| 運動 | g_exercise_rx | 運動処方 |
| 運動 | g_activity_increase | 活動量増加 |
| 運動 | g_exercise_caution | 運動時の注意 |
| 生活 | g_quit_smoking | 禁煙・節煙の有効性 |
| 生活 | g_quit_method | 禁煙の実施方法 |
| 生活 | g_home_measure | 家庭での計測 |
| 生活 | g_lifestyle_other | その他（生活） |
| 就労 | wg_work_hours | 労働時間 |
| 就労 | wg_work_style | 勤務形態 |
| 就労 | wg_sleep | 睡眠の確保 |
| 就労 | wg_leisure | 余暇 |
| 就労 | wg_environment | 作業環境 |
| 就労 | wg_other | その他（就労） |

**出力フォーマット**:
```
■指導項目
・食事摂取量を適正にする
・食塩・調味料を控える
・運動処方（ウォーキング 30分 週3回）

■生活上の問題点
食事量が多く、間食も頻繁。野菜摂取が少ない。

■就労上の問題点
残業が月60時間を超えており、睡眠時間が確保できていない。
```

### 2.2 帳票出力（iD-Heart形式）

**※テンプレートExcelファイル準備後に実装**

参照: `40_労災二次検診/30_共通資料/81_結果入力/iD-Heart_一覧.pdf`

---

## 3. 実装タスク

| 優先度 | タスク | 状態 |
|--------|-------|------|
| 🔴 高 | 企業マスタシート作成 | ✅ 実装済 |
| 🔴 高 | GUIDANCE_COLUMNSに企業ID追加（149,150） | ✅ 実装済 |
| 🔴 高 | CSV取り込み時の企業自動登録 | ✅ 実装済 |
| 🟡 中 | A31セル転記関数 | ✅ 実装済 |
| 🟡 中 | 帳票出力（テンプレート準備後） | 未実装 |
| 🟢 低 | 人間ドック・定期検診の企業選択UI | 未実装 |

---

## 4. 判定エンジン（judgmentEngine.gs）

### 4.1 概要

人間ドック学会2025年度版判定基準に準拠した検査値判定システム。
既存の`judgmentEngine.gs`と新規の`JudgmentLogic.gs`を統合した統合版（v2.1.0）。

### 4.2 主要機能

| 関数名 | 説明 | 用途 |
|--------|------|------|
| `getJudgment(itemId, value, gender)` | 単項目判定 | 検査値→A/B/C/D判定 |
| `judge(itemKey, value, gender)` | 既存互換エイリアス | 後方互換性維持 |
| `judgeByCode(code, valueStr, flag, gender)` | BMLコード判定 | CSV取込時の判定 |
| `getGlucoseHbA1cJudgment(fbs, hba1c)` | 糖代謝組合せ判定 | FBS+HbA1cマトリクス |
| `getBloodPressureJudgment(sys, dia)` | 血圧組合せ判定 | 収縮期+拡張期 |
| `calculateOverallJudgment(judgments)` | 総合判定（シンプル） | 最重判定採用 |
| `calculateOverallJudgmentDetailed(results, gender)` | 総合判定（詳細） | 項目別結果付き |
| `getQualitativeJudgment(value)` | 定性検査判定 | 尿蛋白等の(-)/(+)判定 |
| `apiGetJudgment(params)` | フロントエンドAPI | UI連携用 |
| `batchCalculateJudgments(data)` | バッチ処理 | 複数患者一括判定 |

### 4.3 判定基準データ

**データ取得優先順位**:
1. `判定基準マスタ`シート（動的読み込み）
2. `FALLBACK_JUDGMENT_CRITERIA`定数（フォールバック）

**キャッシュ**: 5分間有効、`clearJudgmentCriteriaCache()`でクリア可能

### 4.4 性別依存項目

| 項目ID | 男性用 | 女性用 |
|--------|--------|--------|
| WAIST | WAIST_M | WAIST_F |
| CREATININE | CREATININE_M | CREATININE_F |
| HEMOGLOBIN | HEMOGLOBIN_M | HEMOGLOBIN_F |

### 4.5 BMLコードマッピング

```javascript
CODE_TO_CRITERIA = {
  '0000481': 'AST',      // AST(GOT)
  '0000482': 'ALT',      // ALT(GPT)
  '0000484': 'GGT',      // γ-GTP
  '0000503': 'FBS',      // 空腹時血糖
  '0003317': 'HBA1C',    // HbA1c
  '0000460': 'HDL_C',    // HDLコレステロール
  '0000410': 'LDL_C',    // LDLコレステロール
  '0000454': 'TG',       // 中性脂肪
  // ... 他20項目
}
```

### 4.6 外部依存

| 依存先 | ファイル | 用途 |
|--------|---------|------|
| CONFIG | Config.gs | シート名定義 |
| getSheet() | utils.gs | シート取得 |
| findPatientRow() | utils.gs | 患者行検索 |
| EXAM_ITEM_MASTER_DATA | MasterData.gs | 項目名取得（オプション） |

※いずれもフォールバック実装あり（外部依存なしでも動作可能）

---

## 改訂履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-12-08 | 1.0 | 初版作成 |
| 2025-12-08 | 1.1 | 決定事項追加、エクセル出力仕様追加 |
| 2025-12-08 | 2.0 | 実装準備完了版に簡略化 |
| 2025-12-08 | 2.1 | 高優先度タスク実装完了（企業マスタ、CSV自動登録、A31転記） |
| 2025-12-17 | 3.0 | 判定エンジン統合版（judgmentEngine.gs v2.1.0）追加 |
