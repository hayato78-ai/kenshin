<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CDmedical 健診システム</title>
  <base target="_top">
  <?!= include('templates/css'); ?>
</head>
<body>
  <!-- ヘッダー -->
  <header class="header">
    <div class="header-brand">
      <h1>CDmedical 健診システム</h1>
    </div>
    <div class="header-actions">
      <span id="currentUser" class="user-info"></span>
    </div>
  </header>

  <!-- メインナビゲーション -->
  <nav class="main-nav">
    <button class="nav-btn active" data-section="patients" onclick="showSection('patients')">
      <span class="nav-icon">👤</span>
      <span class="nav-label">受診者登録</span>
    </button>
    <button class="nav-btn" data-section="csv" onclick="showSection('csv')">
      <span class="nav-icon">📥</span>
      <span class="nav-label">CSV取込</span>
    </button>
    <button class="nav-btn" data-section="results" onclick="showSection('results')">
      <span class="nav-icon">📝</span>
      <span class="nav-label">結果入力</span>
    </button>
    <button class="nav-btn" data-section="reports" onclick="showSection('reports')">
      <span class="nav-icon">📄</span>
      <span class="nav-label">帳票出力</span>
    </button>
    <button class="nav-btn" data-section="billing" onclick="showSection('billing')">
      <span class="nav-icon">💰</span>
      <span class="nav-label">請求管理</span>
    </button>
    <button class="nav-btn" data-section="master" onclick="showSection('master')">
      <span class="nav-icon">⚙️</span>
      <span class="nav-label">マスタ管理</span>
    </button>
  </nav>

  <!-- メインコンテンツ -->
  <main class="main-content">
    <!-- ローディング -->
    <div id="loading" class="loading-overlay" style="display:none;">
      <div class="loading-spinner"></div>
      <p>処理中...</p>
    </div>

    <!-- 通知 -->
    <div id="notification" class="notification" style="display:none;"></div>

    <!-- ========== 受診者登録セクション ========== -->
    <section id="section-patients" class="section active">
      <div class="section-header">
        <h2>受診者登録・検索</h2>
      </div>

      <!-- 検索フォーム（v6: 受診者IDと受診ID両対応） -->
      <div class="search-box">
        <input type="text" id="patientSearchId" placeholder="受診者ID (P-00001)" class="input-sm">
        <input type="text" id="patientSearchName" placeholder="氏名" class="input-md">
        <input type="text" id="patientSearchKana" placeholder="カナ" class="input-md">
        <button class="btn btn-primary" onclick="searchPatients()">検索</button>
        <button class="btn btn-success" onclick="showNewPatientForm()">新規登録</button>
      </div>

      <!-- 検索結果 -->
      <div id="patientSearchResults" class="results-table-container"></div>

      <!-- 受診者詳細・編集パネル -->
      <div id="patientDetailPanel" class="form-panel" style="display:none;">
        <div class="section-header">
          <h3 id="patientDetailTitle">受診者詳細</h3>
          <div>
            <button class="btn btn-sm btn-primary" id="editPatientBtn" onclick="enablePatientEdit()">編集</button>
            <button class="btn btn-sm btn-secondary" onclick="hidePatientDetail()">閉じる</button>
          </div>
        </div>
        <div class="form-grid" id="patientDetailForm">
          <div class="form-group">
            <label>受診ID</label>
            <input type="text" id="detailPatientId" class="input-md" readonly>
          </div>
          <div class="form-group">
            <label>ステータス</label>
            <select id="detailStatus" class="input-sm" disabled>
              <option value="入力中">入力中</option>
              <option value="完了">完了</option>
              <option value="キャンセル">キャンセル</option>
            </select>
          </div>
          <div class="form-group">
            <label>氏名</label>
            <input type="text" id="detailName" class="input-md" readonly>
          </div>
          <div class="form-group">
            <label>カナ</label>
            <input type="text" id="detailKana" class="input-md" readonly>
          </div>
          <div class="form-group">
            <label>生年月日</label>
            <input type="date" id="detailBirthDate" class="input-md" disabled>
          </div>
          <div class="form-group">
            <label>年齢</label>
            <input type="text" id="detailAge" class="input-sm" readonly>
          </div>
          <div class="form-group">
            <label>性別</label>
            <select id="detailGender" class="input-sm" disabled>
              <option value="">選択</option>
              <option value="男">男</option>
              <option value="女">女</option>
            </select>
          </div>
          <div class="form-group">
            <label>受診コース</label>
            <select id="detailCourse" class="input-md" disabled>
              <option value="人間ドック">人間ドック</option>
              <option value="定期健診">定期健診</option>
              <option value="労災二次検診">労災二次検診</option>
              <option value="生活習慣病予防健診">生活習慣病予防健診</option>
            </select>
          </div>
          <div class="form-group">
            <label>受診日</label>
            <input type="date" id="detailExamDate" class="input-md" disabled>
          </div>
          <div class="form-group">
            <label>事業所名</label>
            <input type="text" id="detailCompany" class="input-md" readonly>
          </div>
          <div class="form-group">
            <label>所属</label>
            <input type="text" id="detailDepartment" class="input-md" readonly>
          </div>
          <div class="form-group">
            <label>総合判定</label>
            <select id="detailJudgment" class="input-sm" disabled>
              <option value="">-</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
              <option value="E">E</option>
              <option value="G">G</option>
            </select>
          </div>
        </div>
        <div id="patientDetailActions" class="form-actions" style="display:none;">
          <button class="btn btn-success" onclick="savePatientEdit()">保存</button>
          <button class="btn btn-secondary" onclick="cancelPatientEdit()">キャンセル</button>
          <button class="btn btn-primary" onclick="goToResultInput()">結果入力へ</button>
        </div>

        <!-- 受診履歴セクション（v6: 正規化構造対応） -->
        <div class="visit-history-section">
          <h4>受診履歴</h4>
          <div id="visitHistoryContainer" class="visit-history-container">
            <!-- 受診履歴がここに表示される -->
          </div>
        </div>
      </div>

      <!-- 新規登録フォーム（v6: 正規化構造対応） -->
      <div id="newPatientForm" class="form-panel" style="display:none;">
        <h3 id="newPatientFormTitle">新規受診者登録</h3>

        <!-- 既存患者モード（受診のみ追加時に表示） -->
        <input type="hidden" id="existingPatientId" value="">
        <div id="existingPatientMode" class="existing-patient-info" style="display:none;">
          <div class="info-badge">
            <span class="label">既存患者:</span>
            <span id="existingPatientInfo" class="value">-</span>
          </div>
          <p class="hint">この患者に新しい受診記録を追加します</p>
        </div>

        <div class="form-grid" autocomplete="off">
          <!-- 個人情報セクション（新規患者のみ表示） -->
          <div id="newPatientPersonalInfo" class="personal-info-section">
            <div class="form-group">
              <label>カルテNo. <span class="required">*</span></label>
              <input type="text" id="newPatientKarteNo" class="input-sm auto-next" data-next="newPatientLastName" placeholder="999991" maxlength="6" pattern="[0-9]{6}" autocomplete="off" required>
              <small class="hint">数字6桁</small>
            </div>
            <div class="form-group">
              <label>姓 <span class="required">*</span></label>
              <input type="text" id="newPatientLastName" class="input-sm auto-next" data-next="newPatientFirstName" placeholder="山田" autocomplete="off" required>
            </div>
            <div class="form-group">
              <label>名 <span class="required">*</span></label>
              <input type="text" id="newPatientFirstName" class="input-sm auto-next" data-next="newPatientLastNameKana" placeholder="太郎" autocomplete="off" required>
            </div>
            <div class="form-group">
              <label>セイ <span class="required">*</span></label>
              <input type="text" id="newPatientLastNameKana" class="input-sm auto-next" data-next="newPatientFirstNameKana" placeholder="ヤマダ" autocomplete="off" required>
            </div>
            <div class="form-group">
              <label>メイ <span class="required">*</span></label>
              <input type="text" id="newPatientFirstNameKana" class="input-sm auto-next" data-next="newPatientBirthYear" placeholder="タロウ" autocomplete="off" required>
            </div>
            <div class="form-group birth-date-group">
              <label>生年月日</label>
              <div class="birth-date-inputs">
                <input type="text" id="newPatientBirthYear" class="input-sm birth-year" placeholder="1980" maxlength="4" pattern="[0-9]{4}" autocomplete="off">
                <span class="date-separator">年</span>
                <input type="text" id="newPatientBirthMonth" class="input-xs birth-month" placeholder="01" maxlength="2" pattern="[0-9]{1,2}" autocomplete="off">
                <span class="date-separator">月</span>
                <input type="text" id="newPatientBirthDay" class="input-xs birth-day auto-next" data-next="newPatientGender" placeholder="15" maxlength="2" pattern="[0-9]{1,2}" autocomplete="off">
                <span class="date-separator">日</span>
              </div>
            </div>
            <div class="form-group">
              <label>性別</label>
              <select id="newPatientGender" class="input-sm auto-next" data-next="newPatientExamType">
                <option value="">選択</option>
                <option value="男">男</option>
                <option value="女">女</option>
              </select>
            </div>
            <div class="form-group">
              <label>事業所名</label>
              <input type="text" id="newPatientCompany" class="input-md">
            </div>
          </div>

          <!-- 受診情報セクション（常に表示） -->
          <div class="visit-info-section">
            <div class="form-group">
              <label>検診種別 <span class="required">*</span></label>
              <select id="newPatientExamType" class="input-md auto-next" data-next="newPatientCourse">
                <option value="人間ドック">人間ドック</option>
                <option value="定期健診">定期健診</option>
                <option value="労災二次検診">労災二次検診</option>
                <option value="雇入健診">雇入健診</option>
              </select>
            </div>
            <div class="form-group">
              <label>コース</label>
              <select id="newPatientCourse" class="input-md auto-next" data-next="newPatientExamDate">
                <option value="">選択</option>
                <option value="生活習慣病ドック">生活習慣病ドック</option>
                <option value="消化器ドック">消化器ドック</option>
                <option value="レディースドック">レディースドック</option>
                <option value="定期健康診断A">定期健康診断A</option>
                <option value="定期健康診断B">定期健康診断B</option>
              </select>
            </div>
            <div class="form-group">
              <label>受診日 <span class="required">*</span></label>
              <input type="date" id="newPatientExamDate" class="input-md">
            </div>
          </div>
        </div>
        <div class="form-actions">
          <button class="btn btn-primary" onclick="registerNewPatient()">登録</button>
          <button class="btn btn-secondary" onclick="hideNewPatientForm()">キャンセル</button>
        </div>
      </div>
    </section>

    <!-- ========== CSV取込セクション ========== -->
    <section id="section-csv" class="section">
      <div class="section-header">
        <h2>CSV取込（血液検査結果）</h2>
      </div>

      <div class="upload-area" id="csvDropZone">
        <div class="upload-icon">📁</div>
        <p>CSVファイルをドラッグ＆ドロップ</p>
        <p>または</p>
        <input type="file" id="csvFileInput" accept=".csv" style="display:none;" onchange="handleCsvFile(this)">
        <button class="btn btn-primary" onclick="document.getElementById('csvFileInput').click()">ファイルを選択</button>
      </div>

      <div id="csvPreview" class="csv-preview" style="display:none;">
        <h3>プレビュー</h3>
        <div id="csvPreviewTable"></div>
        <div class="form-actions">
          <button class="btn btn-primary" onclick="executeCsvImport()">取込実行</button>
          <button class="btn btn-secondary" onclick="cancelCsvImport()">キャンセル</button>
        </div>
      </div>

      <div id="csvImportResult" class="import-result" style="display:none;"></div>

      <!-- 進捗一覧 -->
      <div class="progress-section">
        <div class="section-header">
          <h3>取込済み一覧・進捗</h3>
          <button class="btn btn-sm" onclick="loadPatientProgress()">更新</button>
        </div>
        <div id="progressStats" class="progress-stats"></div>
        <div id="patientProgressList" class="results-table-container"></div>
      </div>
    </section>

    <!-- ========== 結果入力セクション（iD-Heart II形式6タブ）========== -->
    <section id="section-results" class="section">
      <div class="section-header">
        <h2>結果入力</h2>
        <div class="header-actions">
          <button class="btn btn-sm btn-secondary" onclick="toggleResultInputMode()">
            <span id="inputModeLabel">簡易入力に切替</span>
          </button>
        </div>
      </div>

      <!-- iD-Heart II形式レイアウト（レイアウト崩れのため非表示） -->
      <div class="result-input-layout" id="idheart-layout" style="display:none;">
        <!-- 左サイドバー：当日受診者リスト -->
        <div class="visitor-sidebar">
          <div class="visitor-header">
            <span class="visitor-date" id="visitorDate"></span>
            <button class="btn btn-xs" onclick="refreshVisitorList()">🔄</button>
          </div>
          <div class="visitor-search">
            <input type="text" id="visitorSearchInput" placeholder="氏名・ID検索" class="input-sm" onkeyup="filterVisitorList()">
          </div>
          <ul class="visitor-list" id="visitorList">
            <!-- 動的に追加 -->
          </ul>
          <div class="visitor-stats">
            <span id="visitorStatsText">0人 / 0人完了</span>
          </div>
        </div>

        <!-- メインエリア -->
        <div class="result-input-main">
          <!-- 患者情報ヘッダー（iD-Heart形式） -->
          <div class="patient-header-idheart" id="patientHeaderIdheart" style="display:none;">
            <div class="patient-row-1">
              <span class="field"><label>受診日:</label><span id="ihVisitDate">-</span></span>
              <span class="field"><label>受診ID:</label><span id="ihVisitId">-</span></span>
              <span class="field"><label>患者ID:</label><span id="ihPatientId">-</span></span>
              <span class="field"><label>コース:</label><span id="ihCourse">-</span></span>
            </div>
            <div class="patient-row-2">
              <span class="field name"><label>氏名:</label><span id="ihPatientName">-</span></span>
              <span class="field"><label>性別:</label><span id="ihGender">-</span></span>
              <span class="field"><label>年齢:</label><span id="ihAge">-</span>歳</span>
              <span class="field"><label>事業所:</label><span id="ihCompany">-</span></span>
            </div>
          </div>

          <!-- 6タブナビゲーション -->
          <div class="input-tabs-6" id="inputTabs6" style="display:none;">
            <button class="tab-6-btn active" data-tab="interview" onclick="showInputTab6('interview')">問診結果</button>
            <button class="tab-6-btn" data-tab="physical" onclick="showInputTab6('physical')">身体情報</button>
            <button class="tab-6-btn" data-tab="laboratory" onclick="showInputTab6('laboratory')">検体検査</button>
            <button class="tab-6-btn" data-tab="imaging" onclick="showInputTab6('imaging')">画像診断</button>
            <button class="tab-6-btn" data-tab="judgment" onclick="showInputTab6('judgment')">判定項目</button>
            <button class="tab-6-btn" data-tab="findings6" onclick="showInputTab6('findings6')">所見文章</button>
          </div>

          <!-- タブコンテンツ：問診結果 -->
          <div id="tab6-interview" class="tab6-content active">
            <div class="input-grid-container">
              <table class="result-input-grid">
                <thead>
                  <tr>
                    <th class="col-code">コード</th>
                    <th class="col-name">項目名</th>
                    <th class="col-current" colspan="3">今回</th>
                    <th class="col-prev" colspan="3">前回</th>
                  </tr>
                  <tr>
                    <th></th><th></th>
                    <th class="col-value">結果</th>
                    <th class="col-judge">判定</th>
                    <th class="col-note">所見</th>
                    <th class="col-value">結果</th>
                    <th class="col-judge">判定</th>
                    <th class="col-note">所見</th>
                  </tr>
                </thead>
                <tbody id="grid-interview"></tbody>
              </table>
            </div>
          </div>

          <!-- タブコンテンツ：身体情報 -->
          <div id="tab6-physical" class="tab6-content">
            <div class="input-grid-container">
              <table class="result-input-grid">
                <thead>
                  <tr>
                    <th class="col-code">コード</th>
                    <th class="col-name">項目名</th>
                    <th class="col-current" colspan="3">今回</th>
                    <th class="col-prev" colspan="3">前回</th>
                  </tr>
                  <tr>
                    <th></th><th></th>
                    <th class="col-value">結果</th>
                    <th class="col-judge">判定</th>
                    <th class="col-note">所見</th>
                    <th class="col-value">結果</th>
                    <th class="col-judge">判定</th>
                    <th class="col-note">所見</th>
                  </tr>
                </thead>
                <tbody id="grid-physical"></tbody>
              </table>
            </div>
          </div>

          <!-- タブコンテンツ：検体検査 -->
          <div id="tab6-laboratory" class="tab6-content">
            <div class="input-grid-container">
              <table class="result-input-grid">
                <thead>
                  <tr>
                    <th class="col-code">コード</th>
                    <th class="col-name">項目名</th>
                    <th class="col-current" colspan="3">今回</th>
                    <th class="col-prev" colspan="3">前回</th>
                  </tr>
                  <tr>
                    <th></th><th></th>
                    <th class="col-value">結果</th>
                    <th class="col-judge">判定</th>
                    <th class="col-note">所見</th>
                    <th class="col-value">結果</th>
                    <th class="col-judge">判定</th>
                    <th class="col-note">所見</th>
                  </tr>
                </thead>
                <tbody id="grid-laboratory"></tbody>
              </table>
            </div>
          </div>

          <!-- タブコンテンツ：画像診断 -->
          <div id="tab6-imaging" class="tab6-content">
            <div class="input-grid-container">
              <table class="result-input-grid">
                <thead>
                  <tr>
                    <th class="col-code">コード</th>
                    <th class="col-name">項目名</th>
                    <th class="col-current" colspan="3">今回</th>
                    <th class="col-prev" colspan="3">前回</th>
                  </tr>
                  <tr>
                    <th></th><th></th>
                    <th class="col-value">結果</th>
                    <th class="col-judge">判定</th>
                    <th class="col-note">所見</th>
                    <th class="col-value">結果</th>
                    <th class="col-judge">判定</th>
                    <th class="col-note">所見</th>
                  </tr>
                </thead>
                <tbody id="grid-imaging"></tbody>
              </table>
            </div>
          </div>

          <!-- タブコンテンツ：判定項目 -->
          <div id="tab6-judgment" class="tab6-content">
            <div class="judgment-summary-panel">
              <h4>3レベル判定サマリー</h4>

              <!-- Level 3: 総合判定 -->
              <div class="judgment-level level-3">
                <span class="level-label">総合判定</span>
                <select id="judgmentLevel3" class="judgment-select">
                  <option value="">-</option>
                  <option value="A">A - 異常なし</option>
                  <option value="B">B - 軽度異常</option>
                  <option value="C">C - 要経過観察</option>
                  <option value="D">D - 要精密検査</option>
                  <option value="E">E - 要治療</option>
                  <option value="F">F - 治療継続</option>
                </select>
                <button class="btn btn-xs btn-secondary" onclick="autoCalcLevel3()">自動算出</button>
              </div>

              <!-- Level 2: カテゴリ判定 -->
              <div class="judgment-level level-2">
                <h5>カテゴリ別判定（Level 2）</h5>
                <div class="category-judgment-grid" id="categoryJudgmentGrid">
                  <!-- 動的に追加 -->
                </div>
              </div>

              <!-- Level 1: 項目別判定（概要） -->
              <div class="judgment-level level-1">
                <h5>項目別判定（Level 1）- 異常値のみ</h5>
                <div class="item-judgment-list" id="itemJudgmentList">
                  <!-- 動的に追加 -->
                </div>
              </div>
            </div>
          </div>

          <!-- タブコンテンツ：所見文章 -->
          <div id="tab6-findings6" class="tab6-content">
            <div class="findings-input-area">
              <div class="findings-row">
                <label>既往歴</label>
                <textarea id="findingsPastHistory" rows="2" class="input-full"></textarea>
              </div>
              <div class="findings-row">
                <label>自覚症状</label>
                <textarea id="findingsSubjective" rows="2" class="input-full"></textarea>
              </div>
              <div class="findings-row">
                <label>他覚症状</label>
                <textarea id="findingsObjective" rows="2" class="input-full"></textarea>
              </div>

              <h5>カテゴリ別所見</h5>
              <div class="findings-row">
                <label>循環器系</label>
                <textarea id="findingsCirculatory" rows="2" class="input-full"></textarea>
              </div>
              <div class="findings-row">
                <label>消化器系</label>
                <textarea id="findingsDigestive" rows="2" class="input-full"></textarea>
              </div>
              <div class="findings-row">
                <label>代謝系（糖）</label>
                <textarea id="findingsMetabolicSugar" rows="2" class="input-full"></textarea>
              </div>
              <div class="findings-row">
                <label>代謝系（脂質）</label>
                <textarea id="findingsMetabolicLipid" rows="2" class="input-full"></textarea>
              </div>
              <div class="findings-row">
                <label>腎機能</label>
                <textarea id="findingsRenal" rows="2" class="input-full"></textarea>
              </div>
              <div class="findings-row">
                <label>血液系</label>
                <textarea id="findingsBlood" rows="2" class="input-full"></textarea>
              </div>
              <div class="findings-row">
                <label>その他</label>
                <textarea id="findingsOther" rows="2" class="input-full"></textarea>
              </div>

              <h5>総合所見</h5>
              <div class="findings-row">
                <label>総合所見</label>
                <textarea id="findingsOverall" rows="4" class="input-full"></textarea>
                <button class="btn btn-xs btn-secondary" onclick="autoGenerateFindings()">自動生成</button>
              </div>

              <h5>画像診断所見</h5>
              <div class="findings-row">
                <label>胸部X線</label>
                <textarea id="findingsChestXray" rows="2" class="input-full"></textarea>
              </div>
              <div class="findings-row">
                <label>心電図</label>
                <textarea id="findingsEcg" rows="2" class="input-full"></textarea>
              </div>
              <div class="findings-row">
                <label>上部消化管</label>
                <textarea id="findingsUpperGI" rows="2" class="input-full"></textarea>
              </div>
              <div class="findings-row">
                <label>腹部超音波</label>
                <textarea id="findingsAbdominalUS" rows="2" class="input-full"></textarea>
              </div>
            </div>
          </div>

          <!-- アクションバー -->
          <div class="result-action-bar" id="resultActionBar" style="display:none;">
            <div class="action-left">
              <button class="btn btn-secondary" onclick="clearCurrentResults()">クリア</button>
            </div>
            <div class="action-center">
              <span class="save-status" id="saveStatus"></span>
            </div>
            <div class="action-right">
              <button class="btn btn-primary" onclick="saveCurrentResults()">保存</button>
              <button class="btn btn-success" onclick="saveAndNextVisitor()">保存して次へ →</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 簡易入力モード（デフォルト表示） -->
      <div class="simple-input-layout" id="simple-layout" style="display:block;">
        <!-- 患者選択 -->
        <div class="patient-selector">
          <div class="search-inline">
            <input type="text" id="resultPatientSearch" placeholder="患者IDまたは氏名で検索" class="input-lg">
            <button class="btn btn-primary" onclick="searchPatientForResults()">検索</button>
          </div>
          <div class="patient-nav">
            <button class="btn btn-sm" onclick="navigatePatient('prev')">← 前へ</button>
            <span id="currentPatientInfo" class="current-patient">患者未選択</span>
            <button class="btn btn-sm" onclick="navigatePatient('next')">次へ →</button>
          </div>
        </div>

        <!-- 患者情報ヘッダー -->
        <div id="selectedPatientHeader" class="patient-header" style="display:none;">
          <div class="patient-basic-info">
            <span class="patient-id"></span>
            <span class="patient-name"></span>
            <span class="patient-birth"></span>
            <span class="patient-gender"></span>
            <span class="patient-age"></span>
          </div>
          <div class="patient-status">
            <span class="status-badge blood">血液: -</span>
            <span class="status-badge body">身体計測: -</span>
            <span class="status-badge findings">所見: -</span>
          </div>
        </div>

        <!-- 入力タブ -->
        <div id="resultInputTabs" class="tabs" style="display:none;">
          <button class="tab-btn active" data-tab="blood" onclick="showResultTab('blood')">血液検査</button>
          <button class="tab-btn" data-tab="lab" onclick="showResultTab('lab')">検体検査</button>
          <button class="tab-btn" data-tab="body" onclick="showResultTab('body')">身体計測</button>
          <button class="tab-btn" data-tab="findings" onclick="showResultTab('findings')">所見入力</button>
        </div>

      <!-- 血液検査タブ -->
      <div id="tab-blood" class="tab-content active">
        <!-- PrismCheckup風 縦並び入力レイアウト -->
        <div class="input-columns">
          <!-- 身体計測 -->
          <div class="input-section">
            <div class="section-title">身体計測</div>
            <div class="input-row"><span class="item-label">身長</span><input type="number" id="btHeight" step="0.1" class="item-input"><span class="item-unit">cm</span></div>
            <div class="input-row"><span class="item-label">体重</span><input type="number" id="btWeight" step="0.1" class="item-input"><span class="item-unit">kg</span></div>
            <div class="input-row"><span class="item-label">BMI</span><input type="text" id="btBMI" class="item-input" readonly><span class="item-unit"></span></div>
            <div class="input-row"><span class="item-label">腹囲</span><input type="number" id="btWaist" step="0.1" class="item-input"><span class="item-unit">cm</span></div>
          </div>

          <!-- 血圧 -->
          <div class="input-section">
            <div class="section-title">血圧</div>
            <div class="input-row"><span class="item-label">収縮期</span><input type="number" id="btSBP" class="item-input"><span class="item-unit">mmHg</span></div>
            <div class="input-row"><span class="item-label">拡張期</span><input type="number" id="btDBP" class="item-input"><span class="item-unit">mmHg</span></div>
            <div class="input-row"><span class="item-label">脈拍</span><input type="number" id="btPulse" class="item-input"><span class="item-unit">/分</span></div>
          </div>

          <!-- 尿検査 -->
          <div class="input-section">
            <div class="section-title">尿検査</div>
            <div class="input-row"><span class="item-label">尿蛋白</span><div class="qual-btns" data-field="btUrineProtein"><button type="button" class="q-btn" data-val="(-)">-</button><button type="button" class="q-btn" data-val="(±)">±</button><button type="button" class="q-btn" data-val="(+)">+</button><button type="button" class="q-btn" data-val="(++)">2+</button><button type="button" class="q-btn" data-val="(+++)">3+</button></div><input type="hidden" id="btUrineProtein"></div>
            <div class="input-row"><span class="item-label">尿糖</span><div class="qual-btns" data-field="btUrineSugar"><button type="button" class="q-btn" data-val="(-)">-</button><button type="button" class="q-btn" data-val="(±)">±</button><button type="button" class="q-btn" data-val="(+)">+</button><button type="button" class="q-btn" data-val="(++)">2+</button><button type="button" class="q-btn" data-val="(+++)">3+</button></div><input type="hidden" id="btUrineSugar"></div>
            <div class="input-row"><span class="item-label">尿潜血</span><div class="qual-btns" data-field="btUrineBlood"><button type="button" class="q-btn" data-val="(-)">-</button><button type="button" class="q-btn" data-val="(±)">±</button><button type="button" class="q-btn" data-val="(+)">+</button><button type="button" class="q-btn" data-val="(++)">2+</button><button type="button" class="q-btn" data-val="(+++)">3+</button></div><input type="hidden" id="btUrineBlood"></div>
          </div>

          <!-- 血球系 -->
          <div class="input-section">
            <div class="section-title">血球系</div>
            <div class="input-row"><span class="item-label">白血球</span><input type="number" id="btWBC" step="0.1" class="item-input"><span class="item-unit">×10²</span></div>
            <div class="input-row"><span class="item-label">赤血球</span><input type="number" id="btRBC" step="1" class="item-input"><span class="item-unit">×10⁴</span></div>
            <div class="input-row"><span class="item-label">Hb</span><input type="number" id="btHb" step="0.1" class="item-input"><span class="item-unit">g/dL</span></div>
            <div class="input-row"><span class="item-label">Ht</span><input type="number" id="btHt" step="0.1" class="item-input"><span class="item-unit">%</span></div>
          </div>

          <!-- 肝機能 -->
          <div class="input-section">
            <div class="section-title">肝機能</div>
            <div class="input-row"><span class="item-label">GOT</span><input type="number" id="btGOT" step="1" class="item-input"><span class="item-unit">U/L</span></div>
            <div class="input-row"><span class="item-label">GPT</span><input type="number" id="btGPT" step="1" class="item-input"><span class="item-unit">U/L</span></div>
            <div class="input-row"><span class="item-label">γ-GTP</span><input type="number" id="btGGTP" step="1" class="item-input"><span class="item-unit">U/L</span></div>
            <div class="input-row"><span class="item-label">ALP</span><input type="number" id="btALP" step="1" class="item-input"><span class="item-unit">U/L</span></div>
          </div>

          <!-- 脂質 -->
          <div class="input-section">
            <div class="section-title">脂質</div>
            <div class="input-row"><span class="item-label">総コレ</span><input type="number" id="btTC" step="1" class="item-input"><span class="item-unit">mg/dL</span></div>
            <div class="input-row"><span class="item-label">HDL</span><input type="number" id="btHDL" step="1" class="item-input"><span class="item-unit">mg/dL</span></div>
            <div class="input-row"><span class="item-label">LDL</span><input type="number" id="btLDL" step="1" class="item-input"><span class="item-unit">mg/dL</span></div>
            <div class="input-row"><span class="item-label">中性脂肪</span><input type="number" id="btTG" step="1" class="item-input"><span class="item-unit">mg/dL</span></div>
          </div>

          <!-- 糖代謝 -->
          <div class="input-section">
            <div class="section-title">糖代謝</div>
            <div class="input-row"><span class="item-label">血糖</span><input type="number" id="btGlu" step="1" class="item-input"><span class="item-unit">mg/dL</span></div>
            <div class="input-row"><span class="item-label">HbA1c</span><input type="number" id="btHbA1c" step="0.1" class="item-input"><span class="item-unit">%</span></div>
          </div>

          <!-- 腎機能 -->
          <div class="input-section">
            <div class="section-title">腎機能</div>
            <div class="input-row"><span class="item-label">尿酸</span><input type="number" id="btUA" step="0.1" class="item-input"><span class="item-unit">mg/dL</span></div>
            <div class="input-row"><span class="item-label">Cr</span><input type="number" id="btCr" step="0.01" class="item-input"><span class="item-unit">mg/dL</span></div>
            <div class="input-row"><span class="item-label">BUN</span><input type="number" id="btBUN" step="0.1" class="item-input"><span class="item-unit">mg/dL</span></div>
            <div class="input-row"><span class="item-label">eGFR</span><input type="number" id="btEGFR" step="0.1" class="item-input"><span class="item-unit">mL/min</span></div>
          </div>

          <!-- 蛋白 -->
          <div class="input-section">
            <div class="section-title">蛋白</div>
            <div class="input-row"><span class="item-label">総蛋白</span><input type="number" id="btTP" step="0.1" class="item-input"><span class="item-unit">g/dL</span></div>
            <div class="input-row"><span class="item-label">Alb</span><input type="number" id="btAlb" step="0.1" class="item-input"><span class="item-unit">g/dL</span></div>
          </div>
        </div>

        <div class="input-actions">
          <button class="btn btn-secondary btn-sm" onclick="clearBloodTestForm()">クリア</button>
          <button class="btn btn-primary" onclick="saveBloodTestResults()">保存</button>
          <button class="btn btn-success" onclick="saveBloodTestResultsAndNext()">保存して次へ →</button>
        </div>
      </div>

      <!-- 検体検査タブ（BML CSV取込データ表示） -->
      <div id="tab-lab" class="tab-content">
        <div class="lab-results-container">
          <div class="lab-results-header">
            <h4>検体検査結果（CSV取込データ）</h4>
            <button class="btn btn-sm btn-secondary" onclick="refreshLabResults()">🔄 再読込</button>
            <button class="btn btn-sm btn-outline" onclick="runLabDiagnostic()">🔧 診断</button>
          </div>
          <div id="labResultsTable" class="lab-results-table">
            <table class="data-table">
              <thead>
                <tr>
                  <th>検査項目</th>
                  <th>結果値</th>
                  <th>単位</th>
                  <th>判定</th>
                </tr>
              </thead>
              <tbody id="labResultsBody">
                <tr><td colspan="4" class="text-center">患者を選択してください</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 身体計測タブ -->
      <div id="tab-body" class="tab-content">
        <div class="form-grid measurement-form">
          <fieldset class="form-fieldset">
            <legend>基本測定</legend>
            <div class="form-row">
              <div class="form-group">
                <label>身長 (cm)</label>
                <input type="number" id="mHeight" step="0.1" class="input-sm">
              </div>
              <div class="form-group">
                <label>体重 (kg)</label>
                <input type="number" id="mWeight" step="0.1" class="input-sm" onchange="calculateBMI()">
              </div>
              <div class="form-group">
                <label>BMI</label>
                <input type="text" id="mBMI" class="input-sm" readonly>
              </div>
            </div>
          </fieldset>

          <fieldset class="form-fieldset">
            <legend>血圧・脈拍</legend>
            <div class="form-row">
              <div class="form-group">
                <label>収縮期 (mmHg)</label>
                <input type="number" id="mSystolicBP" class="input-sm">
              </div>
              <div class="form-group">
                <label>拡張期 (mmHg)</label>
                <input type="number" id="mDiastolicBP" class="input-sm">
              </div>
              <div class="form-group">
                <label>脈拍 (/分)</label>
                <input type="number" id="mPulse" class="input-sm">
              </div>
            </div>
          </fieldset>

          <fieldset class="form-fieldset">
            <legend>視力</legend>
            <div class="form-row">
              <div class="form-group">
                <label>右</label>
                <input type="text" id="mVisionRight" class="input-sm" placeholder="1.0">
              </div>
              <div class="form-group">
                <label>左</label>
                <input type="text" id="mVisionLeft" class="input-sm" placeholder="1.0">
              </div>
              <div class="form-group">
                <label>矯正</label>
                <select id="mVisionCorrected" class="input-sm">
                  <option value="">-</option>
                  <option value="裸眼">裸眼</option>
                  <option value="矯正">矯正</option>
                </select>
              </div>
            </div>
          </fieldset>

          <fieldset class="form-fieldset">
            <legend>聴力</legend>
            <div class="form-row">
              <div class="form-group">
                <label>右 1000Hz</label>
                <select id="mHearingR1000" class="input-sm">
                  <option value="">-</option>
                  <option value="正常">正常</option>
                  <option value="所見あり">所見あり</option>
                </select>
              </div>
              <div class="form-group">
                <label>右 4000Hz</label>
                <select id="mHearingR4000" class="input-sm">
                  <option value="">-</option>
                  <option value="正常">正常</option>
                  <option value="所見あり">所見あり</option>
                </select>
              </div>
              <div class="form-group">
                <label>左 1000Hz</label>
                <select id="mHearingL1000" class="input-sm">
                  <option value="">-</option>
                  <option value="正常">正常</option>
                  <option value="所見あり">所見あり</option>
                </select>
              </div>
              <div class="form-group">
                <label>左 4000Hz</label>
                <select id="mHearingL4000" class="input-sm">
                  <option value="">-</option>
                  <option value="正常">正常</option>
                  <option value="所見あり">所見あり</option>
                </select>
              </div>
            </div>
          </fieldset>

          <fieldset class="form-fieldset">
            <legend>心電図</legend>
            <div class="form-row">
              <div class="form-group">
                <label>所見</label>
                <select id="mEcgFindings" class="input-md">
                  <option value="">選択</option>
                  <option value="異常なし">異常なし</option>
                  <option value="不完全右脚ブロック">不完全右脚ブロック</option>
                  <option value="完全右脚ブロック">完全右脚ブロック</option>
                  <option value="左室肥大">左室肥大</option>
                  <option value="心房細動">心房細動</option>
                  <option value="その他">その他</option>
                </select>
              </div>
              <div class="form-group flex-grow">
                <label>コメント</label>
                <input type="text" id="mEcgComment" class="input-lg">
              </div>
            </div>
          </fieldset>

          <fieldset class="form-fieldset">
            <legend>胸部X線</legend>
            <div class="form-row">
              <div class="form-group">
                <label>所見</label>
                <select id="mXrayFindings" class="input-md">
                  <option value="">選択</option>
                  <option value="異常なし">異常なし</option>
                  <option value="陳旧性病変">陳旧性病変</option>
                  <option value="胸膜肥厚">胸膜肥厚</option>
                  <option value="側弯">側弯</option>
                  <option value="その他">その他</option>
                </select>
              </div>
              <div class="form-group flex-grow">
                <label>コメント</label>
                <input type="text" id="mXrayComment" class="input-lg">
              </div>
            </div>
          </fieldset>
        </div>

        <div class="form-actions">
          <button class="btn btn-primary" onclick="saveBodyMeasurements()">保存</button>
          <button class="btn btn-success" onclick="saveBodyMeasurementsAndNext()">保存して次へ</button>
        </div>
      </div>

      <!-- 所見入力タブ -->
      <div id="tab-findings" class="tab-content">
        <div class="form-grid findings-form">
          <div class="form-group">
            <label>総合判定</label>
            <select id="fOverallJudgment" class="input-md">
              <option value="">選択</option>
              <option value="A">A - 異常なし</option>
              <option value="B">B - 軽度異常</option>
              <option value="C">C - 要経過観察</option>
              <option value="D">D - 要精密検査</option>
              <option value="E">E - 要治療</option>
              <option value="G">G - 現在治療中</option>
            </select>
          </div>

          <div class="form-group full-width">
            <label>総合所見</label>
            <textarea id="fOverallFindings" rows="4" class="input-full"></textarea>
          </div>

          <div class="form-group full-width">
            <label>医師コメント</label>
            <textarea id="fDoctorComment" rows="3" class="input-full"></textarea>
          </div>

          <div class="form-group full-width">
            <label>生活指導</label>
            <textarea id="fLifestyleGuidance" rows="3" class="input-full"></textarea>
          </div>

          <div class="form-group">
            <label>要精密検査項目</label>
            <input type="text" id="fNeedsDetailedExam" class="input-lg" placeholder="カンマ区切り">
          </div>

          <div class="form-group">
            <label>要治療項目</label>
            <input type="text" id="fNeedsTreatment" class="input-lg" placeholder="カンマ区切り">
          </div>
        </div>

        <div class="form-actions">
          <button class="btn btn-primary" onclick="saveFindings()">保存</button>
          <button class="btn btn-success" onclick="saveFindingsAndNext()">保存して次へ</button>
        </div>
      </div>
      </div><!-- /.simple-input-layout -->
    </section>

    <!-- ========== 帳票出力セクション ========== -->
    <section id="section-reports" class="section">
      <div class="section-header">
        <h2>帳票出力</h2>
      </div>

      <div class="report-options">
        <div class="form-group">
          <label>帳票種類</label>
          <select id="reportType" class="input-md">
            <option value="individual">個人結果報告書</option>
            <option value="company">企業一覧表</option>
            <option value="summary">集計表</option>
          </select>
        </div>

        <div class="form-group">
          <label>出力対象</label>
          <select id="reportTarget" class="input-md">
            <option value="selected">選択した患者</option>
            <option value="all">全員（入力完了分）</option>
            <option value="company">企業別</option>
          </select>
        </div>
      </div>

      <div id="reportPatientSelector" class="patient-list-selector">
        <h4>出力対象を選択</h4>
        <div id="reportPatientList"></div>
      </div>

      <div class="form-actions">
        <button class="btn btn-primary" onclick="generateReport()">出力</button>
      </div>

      <div id="reportResult" class="report-result" style="display:none;"></div>
    </section>

    <!-- ========== 請求管理セクション ========== -->
    <section id="section-billing" class="section">
      <div class="section-header">
        <h2>請求管理</h2>
      </div>

      <div class="search-box">
        <select id="billingStatusFilter" class="input-md">
          <option value="">全ステータス</option>
          <option value="未請求">未請求</option>
          <option value="請求済">請求済</option>
          <option value="入金済">入金済</option>
          <option value="キャンセル">キャンセル</option>
        </select>
        <input type="text" id="billingCompanyFilter" placeholder="企業名" class="input-md">
        <input type="month" id="billingMonthFilter" class="input-md">
        <button class="btn btn-primary" onclick="loadBillingList()">検索</button>
        <button class="btn btn-success" onclick="exportBillingToExcel()">Excel出力</button>
      </div>

      <div id="billingStats" class="billing-stats"></div>
      <div id="billingList" class="results-table-container"></div>
    </section>

    <!-- ========== マスタ管理セクション ========== -->
    <section id="section-master" class="section">
      <div class="section-header">
        <h2>マスタ管理</h2>
      </div>

      <!-- マスタ管理タブ -->
      <div class="tabs master-tabs">
        <button class="tab-btn active" data-tab="master-exam-item" onclick="showMasterTab('exam-item')">検査項目</button>
        <button class="tab-btn" data-tab="master-kenpo" onclick="showMasterTab('kenpo')">けんぽ</button>
        <button class="tab-btn" data-tab="master-company" onclick="showMasterTab('company')">事業所</button>
      </div>

      <!-- 検査項目マスタタブ -->
      <div id="tab-master-exam-item" class="tab-content active">
        <div class="master-section">
          <div class="section-header">
            <h3>検査項目マスタ</h3>
            <button class="btn btn-success btn-sm" onclick="showExamItemForm()">+ 新規登録</button>
          </div>

          <!-- 検索エリア -->
          <div class="search-box exam-item-search">
            <div class="form-group">
              <label>項目コード</label>
              <div style="display:flex;gap:5px;align-items:center;">
                <input type="text" id="examCodeFrom" class="input-sm" placeholder="011001">
                <span>～</span>
                <input type="text" id="examCodeTo" class="input-sm" placeholder="099999">
              </div>
            </div>
            <div class="form-group">
              <label>入力区分</label>
              <div style="display:flex;gap:10px;">
                <label style="font-weight:normal;"><input type="checkbox" id="examCatBody"> 身体情報</label>
                <label style="font-weight:normal;"><input type="checkbox" id="examCatLab"> 検体検査</label>
                <label style="font-weight:normal;"><input type="checkbox" id="examCatImg"> 画像診断</label>
              </div>
            </div>
            <div class="form-group">
              <label>検索文字</label>
              <input type="text" id="examKeyword" class="input-md" placeholder="項目名で検索">
            </div>
            <div class="form-group" style="align-self:flex-end;">
              <button class="btn btn-primary" onclick="searchExamItems()">表示</button>
              <button class="btn btn-secondary btn-sm" onclick="clearExamSearch()">クリア</button>
            </div>
          </div>

          <!-- 検査項目一覧 -->
          <div id="examItemList" class="results-table-container">
            <p>検索条件を指定して「表示」をクリックしてください</p>
          </div>
        </div>

        <!-- 検査項目登録・編集モーダル -->
        <div id="examItemModal" class="form-panel" style="display:none;">
          <h4 id="examItemModalTitle">検査項目登録</h4>
          <input type="hidden" id="examItemIsNew" value="true">

          <!-- ヘッダー部 -->
          <div class="form-grid">
            <div class="form-group">
              <label>項目コード <span class="required">*</span></label>
              <input type="text" id="examItemCode" class="input-sm" placeholder="011001" maxlength="6">
            </div>
            <div class="form-group">
              <label>JLAC10コード</label>
              <input type="text" id="examJlac10" class="input-lg" placeholder="9N01000000000001" maxlength="17">
            </div>
            <div class="form-group">
              <label>項目名 <span class="required">*</span></label>
              <input type="text" id="examItemName" class="input-lg" placeholder="身長">
            </div>
            <div class="form-group">
              <label>カナ</label>
              <input type="text" id="examItemKana" class="input-md" placeholder="シンチョウ">
            </div>
            <div class="form-group">
              <label>入力区分</label>
              <div style="display:flex;gap:10px;">
                <label style="font-weight:normal;"><input type="checkbox" id="examIsBody"> 身体情報</label>
                <label style="font-weight:normal;"><input type="checkbox" id="examIsLab"> 検体検査</label>
                <label style="font-weight:normal;"><input type="checkbox" id="examIsImg"> 画像診断</label>
              </div>
            </div>
            <div class="form-group">
              <label>小分類</label>
              <input type="text" id="examSubCategory" class="input-md" placeholder="血球系">
            </div>
          </div>

          <!-- 数値設定 -->
          <fieldset class="form-fieldset">
            <legend>数値設定</legend>
            <div class="form-row">
              <div class="form-group">
                <label>データ型</label>
                <select id="examDataType" class="input-sm">
                  <option value="numeric">数値</option>
                  <option value="text">テキスト</option>
                  <option value="select">選択</option>
                </select>
              </div>
              <div class="form-group">
                <label>小数桁数</label>
                <input type="number" id="examDecimal" class="input-xs" min="0" max="4" value="0">
              </div>
              <div class="form-group">
                <label>単位</label>
                <input type="text" id="examUnit" class="input-sm" placeholder="cm">
              </div>
              <div class="form-group">
                <label>有効範囲</label>
                <div style="display:flex;gap:5px;align-items:center;">
                  <input type="number" id="examValidMin" class="input-sm" placeholder="0">
                  <span>～</span>
                  <input type="number" id="examValidMax" class="input-sm" placeholder="999">
                </div>
              </div>
            </div>
          </fieldset>

          <!-- 判定基準 -->
          <fieldset class="form-fieldset">
            <legend>判定基準</legend>
            <div class="criteria-grid-container">
              <table class="results-table criteria-table">
                <thead>
                  <tr>
                    <th>判定</th>
                    <th colspan="2">男性</th>
                    <th colspan="2">女性</th>
                  </tr>
                  <tr>
                    <th></th>
                    <th>下限</th>
                    <th>上限</th>
                    <th>下限</th>
                    <th>上限</th>
                  </tr>
                </thead>
                <tbody id="criteriaGrid">
                  <!-- F L～F H の11行 -->
                </tbody>
              </table>
            </div>
          </fieldset>

          <!-- 基準値表記 -->
          <div class="form-grid">
            <div class="form-group">
              <label>帳票基準値（男性）</label>
              <input type="text" id="examStdMale" class="input-md" placeholder="18.5～24.9">
            </div>
            <div class="form-group">
              <label>帳票基準値（女性）</label>
              <input type="text" id="examStdFemale" class="input-md" placeholder="18.5～24.9">
            </div>
          </div>

          <!-- その他 -->
          <fieldset class="form-fieldset">
            <legend>その他設定</legend>
            <div class="form-grid">
              <div class="form-group">
                <label>初期値</label>
                <input type="text" id="examDefaultValue" class="input-sm">
              </div>
              <div class="form-group">
                <label>検査会社コード（BML）</label>
                <input type="text" id="examLabCodeBml" class="input-sm">
              </div>
              <div class="form-group">
                <label>表示順</label>
                <input type="number" id="examDisplayOrder" class="input-sm" value="0">
              </div>
              <div class="form-group full-width">
                <label>備考</label>
                <textarea id="examNotes" rows="2" class="input-full"></textarea>
              </div>
            </div>
          </fieldset>

          <div class="form-actions">
            <button class="btn btn-primary" onclick="saveExamItem()">保存</button>
            <button class="btn btn-danger" onclick="deleteExamItem()" id="examDeleteBtn" style="display:none;">削除</button>
            <button class="btn btn-secondary" onclick="hideExamItemForm()">キャンセル</button>
          </div>
        </div>
      </div>

      <!-- けんぽマスタタブ -->
      <div id="tab-master-kenpo" class="tab-content">
        <div class="master-section">
          <div class="section-header">
            <h3>けんぽ（健康保険組合）一覧</h3>
            <button class="btn btn-success btn-sm" onclick="showKenpoForm()">+ 新規登録</button>
          </div>

          <!-- けんぽ登録フォーム -->
          <div id="kenpoForm" class="form-panel" style="display:none;">
            <h4 id="kenpoFormTitle">けんぽ新規登録</h4>
            <input type="hidden" id="kenpoId">
            <div class="form-grid">
              <div class="form-group">
                <label>けんぽコード <span class="required">*</span></label>
                <input type="text" id="kenpoCode" class="input-sm" placeholder="K001" maxlength="10" required>
              </div>
              <div class="form-group">
                <label>けんぽ名称 <span class="required">*</span></label>
                <input type="text" id="kenpoName" class="input-lg" placeholder="○○健康保険組合" required>
              </div>
              <div class="form-group">
                <label>略称</label>
                <input type="text" id="kenpoShortName" class="input-md" placeholder="○○けんぽ">
              </div>
              <div class="form-group">
                <label>住所</label>
                <input type="text" id="kenpoAddress" class="input-lg" placeholder="東京都○○区...">
              </div>
              <div class="form-group">
                <label>電話番号</label>
                <input type="text" id="kenpoPhone" class="input-md" placeholder="03-0000-0000">
              </div>
              <div class="form-group">
                <label>担当者</label>
                <input type="text" id="kenpoContact" class="input-md" placeholder="山田太郎">
              </div>
              <div class="form-group full-width">
                <label>備考</label>
                <textarea id="kenpoNote" rows="2" class="input-full"></textarea>
              </div>
            </div>
            <div class="form-actions">
              <button class="btn btn-primary" onclick="saveKenpo()">保存</button>
              <button class="btn btn-secondary" onclick="hideKenpoForm()">キャンセル</button>
            </div>
          </div>

          <!-- けんぽ一覧 -->
          <div id="kenpoList" class="results-table-container">
            <p>読み込み中...</p>
          </div>
        </div>
      </div>

      <!-- 事業所マスタタブ -->
      <div id="tab-master-company" class="tab-content">
        <div class="master-section">
          <div class="section-header">
            <h3>事業所一覧</h3>
            <button class="btn btn-success btn-sm" onclick="showCompanyForm()">+ 新規登録</button>
          </div>

          <!-- 事業所登録フォーム -->
          <div id="companyForm" class="form-panel" style="display:none;">
            <h4 id="companyFormTitle">事業所新規登録</h4>
            <input type="hidden" id="companyId">
            <div class="form-grid">
              <div class="form-group">
                <label>事業所コード <span class="required">*</span></label>
                <input type="text" id="companyCode" class="input-sm" placeholder="C001" maxlength="10" required>
              </div>
              <div class="form-group">
                <label>事業所名 <span class="required">*</span></label>
                <input type="text" id="companyName" class="input-lg" placeholder="株式会社○○" required>
              </div>
              <div class="form-group">
                <label>所属けんぽ</label>
                <select id="companyKenpo" class="input-md">
                  <option value="">選択</option>
                  <!-- JSで動的に追加 -->
                </select>
              </div>
              <div class="form-group">
                <label>住所</label>
                <input type="text" id="companyAddress" class="input-lg" placeholder="東京都○○区...">
              </div>
              <div class="form-group">
                <label>電話番号</label>
                <input type="text" id="companyPhone" class="input-md" placeholder="03-0000-0000">
              </div>
              <div class="form-group">
                <label>担当者</label>
                <input type="text" id="companyContact" class="input-md" placeholder="山田太郎">
              </div>
              <div class="form-group">
                <label>従業員数</label>
                <input type="number" id="companyEmployeeCount" class="input-sm" placeholder="100">
              </div>
              <div class="form-group full-width">
                <label>備考</label>
                <textarea id="companyNote" rows="2" class="input-full"></textarea>
              </div>
            </div>
            <div class="form-actions">
              <button class="btn btn-primary" onclick="saveCompany()">保存</button>
              <button class="btn btn-secondary" onclick="hideCompanyForm()">キャンセル</button>
            </div>
          </div>

          <!-- 事業所一覧 -->
          <div id="companyList" class="results-table-container">
            <p>読み込み中...</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- フッター -->
  <footer class="footer">
    <p>CDmedical 健診システム v1.0.0</p>
  </footer>

  <?!= include('templates/js'); ?>

  <script>
    // 初期データの読み込み
    const initialData = <?!= initialData ?>;
    document.getElementById('currentUser').textContent = initialData.user || '';

    // 初期化
    document.addEventListener('DOMContentLoaded', function() {
      initializePortal();
    });
  </script>
</body>
</html>
