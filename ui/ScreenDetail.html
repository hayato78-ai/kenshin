<!--
  å¥è¨ºçµæœDB çµ±åˆã‚·ã‚¹ãƒ†ãƒ  - å—è¨ºè€…è©³ç´°ç”»é¢ (SCR-005)

  @description UIè¨­è¨ˆæ›¸: å¥è¨ºçµæœDB_UIè¨­è¨ˆæ›¸_v1.md 2.5ç« 
  @version 1.0.0
  @date 2025-12-14
-->

<div id="screen-detail" class="screen hidden">
  <div class="main-content">
    <!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="flex-between mb-lg">
      <h1 style="font-size: var(--font-size-xl);">å—è¨ºè€…è©³ç´°</h1>
      <a href="javascript:void(0)" class="btn btn-outline" onclick="App.goBack()">
        ä¸€è¦§ã«æˆ»ã‚‹
      </a>
    </div>

    <!-- åŸºæœ¬æƒ…å ±ã‚«ãƒ¼ãƒ‰ -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">åŸºæœ¬æƒ…å ±</span>
        <button class="btn btn-sm btn-outline" onclick="PatientDetail.showEditModal()">ç·¨é›†</button>
      </div>
      <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--spacing-md);">
          <div>
            <div class="text-secondary" style="font-size: var(--font-size-sm);">å—è¨ºè€…ID</div>
            <div id="detail-patient-id" style="font-size: var(--font-size-lg); font-weight: bold;">-</div>
          </div>
          <div>
            <div class="text-secondary" style="font-size: var(--font-size-sm);">æ°å</div>
            <div id="detail-name" style="font-size: var(--font-size-lg); font-weight: bold;">-</div>
          </div>
          <div>
            <div class="text-secondary" style="font-size: var(--font-size-sm);">ã‚«ãƒŠ</div>
            <div id="detail-name-kana">-</div>
          </div>
          <div>
            <div class="text-secondary" style="font-size: var(--font-size-sm);">æ€§åˆ¥</div>
            <div id="detail-gender">-</div>
          </div>
          <div>
            <div class="text-secondary" style="font-size: var(--font-size-sm);">ç”Ÿå¹´æœˆæ—¥</div>
            <div id="detail-birth-date">-</div>
          </div>
          <div>
            <div class="text-secondary" style="font-size: var(--font-size-sm);">å¹´é½¢</div>
            <div id="detail-age">-</div>
          </div>
          <div>
            <div class="text-secondary" style="font-size: var(--font-size-sm);">é›»è©±ç•ªå·</div>
            <div id="detail-phone">-</div>
          </div>
          <div>
            <div class="text-secondary" style="font-size: var(--font-size-sm);">ä¼æ¥­å</div>
            <div id="detail-company">-</div>
          </div>
        </div>
      </div>
    </div>

    <!-- å—è¨ºå±¥æ­´ã‚«ãƒ¼ãƒ‰ -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">å—è¨ºå±¥æ­´</span>
        <button class="btn btn-sm btn-primary" onclick="PatientDetail.newVisit()">æ–°è¦å—è¨ºç™»éŒ²</button>
      </div>
      <div class="card-body" style="padding: 0;">
        <div class="table-container">
          <table class="table" id="visit-history-table">
            <thead>
              <tr>
                <th>å—è¨ºæ—¥</th>
                <th>æ¤œè¨ºç¨®åˆ¥</th>
                <th>ã‚³ãƒ¼ã‚¹</th>
                <th>ç·åˆåˆ¤å®š</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="visit-history-body">
              <tr>
                <td colspan="5" class="text-center text-secondary">èª­ã¿è¾¼ã¿ä¸­...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- æ“ä½œãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">æ“ä½œãƒ¡ãƒ‹ãƒ¥ãƒ¼</span>
      </div>
      <div class="card-body">
        <div class="flex gap-md" style="flex-wrap: wrap;">
          <button class="btn btn-outline" onclick="PatientDetail.showGuidance()">
            ä¿å¥æŒ‡å°è¨˜éŒ²
          </button>
          <button class="btn btn-outline" onclick="PatientDetail.showReportModal()">
            å¸³ç¥¨å‡ºåŠ›
          </button>
          <button class="btn btn-outline" onclick="PatientDetail.exportCSV()">
            ãƒ‡ãƒ¼ã‚¿å‡ºåŠ›(CSV)
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Excelå‡ºåŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<template id="export-excel-modal-template">
  <div class="modal-overlay" id="export-excel-modal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">Excelå‡ºåŠ›</span>
        <button class="modal-close" onclick="PatientDetail.closeExportModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label">å—è¨ºæ—¥</label>
          <div id="export-visit-date" style="font-weight: bold;">-</div>
        </div>
        <div class="form-group">
          <label class="form-label">æ¤œè¨ºç¨®åˆ¥</label>
          <div id="export-exam-type" style="font-weight: bold;">-</div>
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
          <select id="export-template" class="form-control">
            <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">ãƒ•ã‚¡ã‚¤ãƒ«å</label>
          <input type="text" id="export-filename" class="form-control" placeholder="æ‚£è€…å_å—è¨ºæ—¥.xlsx">
          <div class="form-hint">æ‹¡å¼µå­ã¯è‡ªå‹•ã§ä»˜ä¸ã•ã‚Œã¾ã™</div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="PatientDetail.closeExportModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="PatientDetail.executeExport()">
          <span id="export-btn-text">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
        </button>
      </div>
    </div>
  </div>
</template>

<!-- åŸºæœ¬æƒ…å ±ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<template id="edit-patient-modal-template">
  <div class="modal-overlay" id="edit-patient-modal">
    <div class="modal">
      <div class="modal-header">
        <span class="modal-title">åŸºæœ¬æƒ…å ±ç·¨é›†</span>
        <button class="modal-close" onclick="PatientDetail.closeEditModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label class="form-label required">æ°å</label>
          <input type="text" id="edit-name" class="form-control">
        </div>
        <div class="form-group">
          <label class="form-label required">ã‚«ãƒŠ</label>
          <input type="text" id="edit-name-kana" class="form-control">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label required">ç”Ÿå¹´æœˆæ—¥</label>
            <input type="date" id="edit-birth-date" class="form-control">
          </div>
          <div class="form-group">
            <label class="form-label required">æ€§åˆ¥</label>
            <select id="edit-gender" class="form-control">
              <option value="M">ç”·æ€§</option>
              <option value="F">å¥³æ€§</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">é›»è©±ç•ªå·</label>
          <input type="tel" id="edit-phone" class="form-control">
        </div>
        <div class="form-group">
          <label class="form-label">ä¼æ¥­å</label>
          <input type="text" id="edit-company" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" onclick="PatientDetail.closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="PatientDetail.savePatient()">ä¿å­˜</button>
      </div>
    </div>
  </div>
</template>

<script>
/**
 * å—è¨ºè€…è©³ç´°ç”»é¢ã®å‡¦ç†
 */
const PatientDetail = {
  /** ç¾åœ¨ã®å—è¨ºè€…ãƒ‡ãƒ¼ã‚¿ */
  patient: null,

  /** å—è¨ºå±¥æ­´ */
  visits: [],

  /**
   * åˆæœŸåŒ–
   * @param {Object} params - ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
   */
  init: function(params) {
    console.log('PatientDetail.init', params);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¿½åŠ 
    this.setupModal();

    if (params && params.patientId) {
      this.loadPatient(params.patientId);
    } else if (App.state.currentPatient) {
      this.loadPatient(App.state.currentPatient.patientId);
    } else {
      App.showMessage('ã‚¨ãƒ©ãƒ¼', 'å—è¨ºè€…ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
      App.navigate('search');
    }
  },

  /**
   * ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
   */
  setupModal: function() {
    if (!document.getElementById('edit-patient-modal')) {
      const template = document.getElementById('edit-patient-modal-template');
      if (template) {
        const clone = template.content.cloneNode(true);
        document.body.appendChild(clone);
        document.getElementById('edit-patient-modal').classList.add('hidden');
      }
    }
  },

  /**
   * å—è¨ºè€…æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
   * @param {string} patientId - å—è¨ºè€…ID
   */
  loadPatient: function(patientId) {
    const self = this;
    App.showLoading();

    google.script.run
      .withSuccessHandler(function(patient) {
        App.hideLoading();
        if (patient) {
          self.patient = patient;
          App.state.currentPatient = patient;
          self.renderPatientInfo();
          self.loadVisitHistory(patientId);
        } else {
          App.showMessage('ã‚¨ãƒ©ãƒ¼', 'å—è¨ºè€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
          App.navigate('search');
        }
      })
      .withFailureHandler(function(error) {
        App.hideLoading();
        console.error('Failed to load patient:', error);
        App.showMessage('ã‚¨ãƒ©ãƒ¼', 'å—è¨ºè€…æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      })
      .getPatientById(patientId);
  },

  /**
   * å—è¨ºè€…æƒ…å ±ã‚’æç”»
   */
  renderPatientInfo: function() {
    const p = this.patient;
    if (!p) return;

    document.getElementById('detail-patient-id').textContent = p.patientId || '-';
    document.getElementById('detail-name').textContent = p.name || '-';
    document.getElementById('detail-name-kana').textContent = p.nameKana || '-';
    document.getElementById('detail-gender').textContent = App.formatGender(p.gender);
    document.getElementById('detail-birth-date').textContent = p.birthDate ? App.formatDate(p.birthDate) : '-';
    document.getElementById('detail-age').textContent = p.birthDate ? App.calculateAge(p.birthDate) + 'æ­³' : '-';
    document.getElementById('detail-phone').textContent = p.phone || '-';
    document.getElementById('detail-company').textContent = p.company || '-';
  },

  /**
   * å—è¨ºå±¥æ­´ã‚’èª­ã¿è¾¼ã¿
   * @param {string} patientId - å—è¨ºè€…ID
   */
  loadVisitHistory: function(patientId) {
    const self = this;

    google.script.run
      .withSuccessHandler(function(visits) {
        self.visits = visits || [];
        self.renderVisitHistory();
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load visit history:', error);
        self.visits = [];
        self.renderVisitHistory();
      })
      .getVisitRecordsByPatientId(patientId);
  },

  /**
   * å—è¨ºå±¥æ­´ã‚’æç”»
   */
  renderVisitHistory: function() {
    const tbody = document.getElementById('visit-history-body');
    if (!tbody) return;

    if (this.visits.length === 0) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-secondary">å—è¨ºå±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }

    let html = '';
    this.visits.forEach(function(visit) {
      const hasInput = visit.status !== 'CONFIRMED' && visit.status !== 'REPORTED';

      html += '<tr>';
      html += '<td>' + App.formatDate(visit.visitDate) + '</td>';
      html += '<td>' + (visit.examTypeName || visit.examTypeId || '-') + '</td>';
      html += '<td>' + (visit.courseName || '-') + '</td>';
      html += '<td>' + App.getJudgmentBadge(visit.overallJudgment) + '</td>';
      html += '<td>';
      html += '<button class="btn btn-sm btn-outline" onclick="PatientDetail.viewResult(\'' + visit.visitId + '\')">çµæœ</button>';
      if (hasInput) {
        html += ' <button class="btn btn-sm btn-primary" onclick="PatientDetail.inputResult(\'' + visit.visitId + '\')">å…¥åŠ›</button>';
      }
      html += ' <button class="btn btn-sm btn-outline" onclick="PatientDetail.showExportModal(\'' + visit.visitId + '\')" title="Excelå‡ºåŠ›">ğŸ“¥</button>';
      html += '</td>';
      html += '</tr>';
    });

    tbody.innerHTML = html;
  },

  /**
   * æ¤œæŸ»çµæœã‚’è¡¨ç¤º
   * @param {string} visitId - å—è¨ºID
   */
  viewResult: function(visitId) {
    const visit = this.visits.find(function(v) { return v.visitId === visitId; });
    if (visit) {
      App.state.currentVisit = visit;
    }
    App.navigate('result', { visitId: visitId });
  },

  /**
   * æ¤œæŸ»çµæœã‚’å…¥åŠ›
   * @param {string} visitId - å—è¨ºID
   */
  inputResult: function(visitId) {
    const visit = this.visits.find(function(v) { return v.visitId === visitId; });
    if (visit) {
      App.state.currentVisit = visit;
    }
    App.navigate('input', { visitId: visitId });
  },

  /**
   * æ–°è¦å—è¨ºç™»éŒ²
   */
  newVisit: function() {
    App.navigate('register', { patientId: this.patient?.patientId });
  },

  /**
   * ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
   */
  showEditModal: function() {
    const modal = document.getElementById('edit-patient-modal');
    if (!modal || !this.patient) return;

    // ç¾åœ¨ã®å€¤ã‚’ã‚»ãƒƒãƒˆ
    document.getElementById('edit-name').value = this.patient.name || '';
    document.getElementById('edit-name-kana').value = this.patient.nameKana || '';
    document.getElementById('edit-birth-date').value = this.patient.birthDate || '';
    document.getElementById('edit-gender').value = this.patient.gender || 'M';
    document.getElementById('edit-phone').value = this.patient.phone || '';
    document.getElementById('edit-company').value = this.patient.company || '';

    modal.classList.remove('hidden');
  },

  /**
   * ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
   */
  closeEditModal: function() {
    const modal = document.getElementById('edit-patient-modal');
    if (modal) {
      modal.classList.add('hidden');
    }
  },

  /**
   * å—è¨ºè€…æƒ…å ±ã‚’ä¿å­˜
   */
  savePatient: function() {
    const self = this;

    const data = {
      name: document.getElementById('edit-name').value.trim(),
      nameKana: document.getElementById('edit-name-kana').value.trim(),
      birthDate: document.getElementById('edit-birth-date').value,
      gender: document.getElementById('edit-gender').value,
      phone: document.getElementById('edit-phone').value.trim(),
      company: document.getElementById('edit-company').value.trim()
    };

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!data.name) {
      App.showMessage('ã‚¨ãƒ©ãƒ¼', 'æ°åã¯å¿…é ˆã§ã™', 'error');
      return;
    }
    if (!data.nameKana) {
      App.showMessage('ã‚¨ãƒ©ãƒ¼', 'ã‚«ãƒŠã¯å¿…é ˆã§ã™', 'error');
      return;
    }
    if (!data.birthDate) {
      App.showMessage('ã‚¨ãƒ©ãƒ¼', 'ç”Ÿå¹´æœˆæ—¥ã¯å¿…é ˆã§ã™', 'error');
      return;
    }

    App.showLoading();

    google.script.run
      .withSuccessHandler(function(success) {
        App.hideLoading();
        if (success) {
          self.closeEditModal();
          App.showMessage('æˆåŠŸ', 'ä¿å­˜ã—ã¾ã—ãŸ', 'success');
          self.loadPatient(self.patient.patientId);
        } else {
          App.showMessage('ã‚¨ãƒ©ãƒ¼', 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
      })
      .withFailureHandler(function(error) {
        App.hideLoading();
        console.error('Failed to save patient:', error);
        App.showMessage('ã‚¨ãƒ©ãƒ¼', 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      })
      .updatePatient(self.patient.patientId, data);
  },

  /**
   * ä¿å¥æŒ‡å°è¨˜éŒ²ã‚’è¡¨ç¤º
   */
  showGuidance: function() {
    App.showMessage('æœªå®Ÿè£…', 'ã“ã®æ©Ÿèƒ½ã¯ Phase 3 ã§å®Ÿè£…äºˆå®šã§ã™', 'info');
  },

  /**
   * å¸³ç¥¨å‡ºåŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆæ“ä½œãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ï¼‰
   */
  showReportModal: function() {
    // æœ€æ–°ã®å—è¨ºã‚’é¸æŠ
    if (this.visits && this.visits.length > 0) {
      this.showExportModal(this.visits[0].visitId);
    } else {
      App.showMessage('ã‚¨ãƒ©ãƒ¼', 'å‡ºåŠ›ã™ã‚‹å—è¨ºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
    }
  },

  /**
   * CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
   */
  exportCSV: function() {
    App.showMessage('æœªå®Ÿè£…', 'ã“ã®æ©Ÿèƒ½ã¯ Phase 3 ã§å®Ÿè£…äºˆå®šã§ã™', 'info');
  },

  // ============================================
  // Excelå‡ºåŠ›æ©Ÿèƒ½
  // ============================================

  /** å‡ºåŠ›å¯¾è±¡ã®å—è¨ºID */
  exportVisitId: null,

  /** ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ */
  templates: [],

  /**
   * Excelå‡ºåŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
   * @param {string} visitId - å—è¨ºID
   */
  showExportModal: function(visitId) {
    const self = this;

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¿½åŠ 
    if (!document.getElementById('export-excel-modal')) {
      const template = document.getElementById('export-excel-modal-template');
      if (template) {
        const clone = template.content.cloneNode(true);
        document.body.appendChild(clone);
        document.getElementById('export-excel-modal').classList.add('hidden');
      }
    }

    this.exportVisitId = visitId;

    // å—è¨ºæƒ…å ±ã‚’å–å¾—
    const visit = this.visits.find(function(v) { return v.visitId === visitId; });
    if (!visit) {
      App.showMessage('ã‚¨ãƒ©ãƒ¼', 'å—è¨ºæƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
      return;
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«æƒ…å ±ã‚’è¨­å®š
    document.getElementById('export-visit-date').textContent = App.formatDate(visit.visitDate);
    document.getElementById('export-exam-type').textContent = visit.examTypeName || visit.examTypeId || '-';

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¨­å®š
    const dateStr = App.formatDate(visit.visitDate, 'yyyymmdd');
    const defaultFileName = (this.patient?.name || 'æ‚£è€…') + '_' + dateStr;
    document.getElementById('export-filename').value = defaultFileName;

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    this.loadTemplates();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    document.getElementById('export-excel-modal').classList.remove('hidden');
  },

  /**
   * Excelå‡ºåŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
   */
  closeExportModal: function() {
    const modal = document.getElementById('export-excel-modal');
    if (modal) {
      modal.classList.add('hidden');
    }
    this.exportVisitId = null;
  },

  /**
   * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
   */
  loadTemplates: function() {
    const self = this;
    const select = document.getElementById('export-template');

    google.script.run
      .withSuccessHandler(function(data) {
        self.templates = data.templates || [];

        select.innerHTML = '';

        if (self.templates.length === 0) {
          select.innerHTML = '<option value="">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</option>';
          return;
        }

        self.templates.forEach(function(t) {
          const option = document.createElement('option');
          option.value = t.templateId;
          option.textContent = t.name + ' (' + t.examType + ')';
          select.appendChild(option);
        });
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load templates:', error);
        select.innerHTML = '<option value="">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>';
      })
      .getTemplateManagementData();
  },

  /**
   * Excelå‡ºåŠ›ã‚’å®Ÿè¡Œ
   */
  executeExport: function() {
    const self = this;

    const templateId = document.getElementById('export-template').value;
    const fileName = document.getElementById('export-filename').value.trim();

    if (!templateId) {
      App.showMessage('ã‚¨ãƒ©ãƒ¼', 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
      return;
    }

    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const btnText = document.getElementById('export-btn-text');
    btnText.textContent = 'å‡¦ç†ä¸­...';

    App.showLoading();

    google.script.run
      .withSuccessHandler(function(result) {
        App.hideLoading();
        btnText.textContent = 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';

        if (result.success) {
          // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹
          self.closeExportModal();
          self.downloadFile(result.downloadUrl, result.fileName);
          App.showMessage('æˆåŠŸ', 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡ºåŠ›ã—ã¾ã—ãŸ', 'success');
        } else {
          App.showMessage('ã‚¨ãƒ©ãƒ¼', result.error || 'å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
        }
      })
      .withFailureHandler(function(error) {
        App.hideLoading();
        btnText.textContent = 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰';
        console.error('Export failed:', error);
        App.showMessage('ã‚¨ãƒ©ãƒ¼', 'å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
      })
      .apiExportExcel(self.exportVisitId, templateId, fileName);
  },

  /**
   * ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
   * @param {string} url - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL
   * @param {string} fileName - ãƒ•ã‚¡ã‚¤ãƒ«å
   */
  downloadFile: function(url, fileName) {
    // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const a = document.createElement('a');
    a.href = url;
    a.target = '_blank';
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }
};
</script>
