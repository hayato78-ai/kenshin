<!--
  å¥è¨ºçµæœDB çµ±åˆã‚·ã‚¹ãƒ†ãƒ  - ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ (SCR-002)

  @description UIè¨­è¨ˆæ›¸: å¥è¨ºçµæœDB_UIè¨­è¨ˆæ›¸_v1.md 2.2ç« 
  @version 1.0.0
  @date 2025-12-14
-->

<div id="screen-menu" class="screen">
  <div class="main-content">
    <!-- ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
    <div class="mb-lg">
      <h1 style="font-size: var(--font-size-xxl); color: var(--color-text);">
        ã‚ˆã†ã“ãã€<span id="menu-user-name">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>ã•ã‚“
      </h1>
    </div>

    <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚°ãƒªãƒƒãƒ‰ -->
    <div class="menu-grid">
      <a href="#" class="menu-card" onclick="App.navigate('search'); return false;">
        <div class="menu-card-icon">ğŸ”</div>
        <div class="menu-card-title">å—è¨ºè€…æ¤œç´¢</div>
      </a>

      <a href="#" class="menu-card" onclick="App.navigate('register'); return false;">
        <div class="menu-card-icon">ğŸ“</div>
        <div class="menu-card-title">æ–°è¦ç™»éŒ²</div>
      </a>

      <a href="#" class="menu-card" onclick="App.navigate('report'); return false;">
        <div class="menu-card-icon">ğŸ“Š</div>
        <div class="menu-card-title">ãƒ¬ãƒãƒ¼ãƒˆ</div>
      </a>

      <a href="#" class="menu-card" onclick="App.navigate('master'); return false;">
        <div class="menu-card-icon">âš™ï¸</div>
        <div class="menu-card-title">ãƒã‚¹ã‚¿ç®¡ç†</div>
      </a>

      <a href="#" class="menu-card" onclick="App.navigate('import'); return false;">
        <div class="menu-card-icon">ğŸ“¥</div>
        <div class="menu-card-title">CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
      </a>
    </div>

    <!-- ã‚»ãƒ‘ãƒ¬ãƒ¼ã‚¿ãƒ¼ -->
    <hr style="border: none; border-top: 1px solid var(--color-border); margin: var(--spacing-lg) 0;">

    <!-- æœ¬æ—¥ã®ã‚µãƒãƒªãƒ¼ -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">æœ¬æ—¥ã®ã‚µãƒãƒªãƒ¼</span>
        <button class="btn btn-sm btn-outline" onclick="Menu.refreshSummary()">æ›´æ–°</button>
      </div>
      <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--spacing-md);">
          <div class="summary-card">
            <div class="summary-title">æœ¬æ—¥ã®å—è¨ºäºˆå®š</div>
            <div class="summary-value" id="summary-today-visits">-</div>
          </div>

          <div class="summary-card">
            <div class="summary-title">å…¥åŠ›å¾…ã¡</div>
            <div class="summary-value" id="summary-pending-input">-</div>
          </div>

          <div class="summary-card">
            <div class="summary-title">æœŸé™è¶…é</div>
            <div class="summary-value summary-warning" id="summary-overdue">
              <span id="summary-overdue-count">-</span>
              <span id="summary-overdue-warning" class="hidden" style="font-size: var(--font-size-md);"> âš ï¸</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æœ€è¿‘ã®å—è¨º -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">æœ€è¿‘ã®å—è¨º</span>
        <a href="#" class="btn btn-sm btn-outline" onclick="App.navigate('search'); return false;">ã™ã¹ã¦è¡¨ç¤º</a>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table class="table" id="recent-visits-table">
            <thead>
              <tr>
                <th>å—è¨ºæ—¥</th>
                <th>å—è¨ºè€…ID</th>
                <th>æ°å</th>
                <th>æ¤œè¨ºç¨®åˆ¥</th>
                <th>ç·åˆåˆ¤å®š</th>
                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
              </tr>
            </thead>
            <tbody id="recent-visits-body">
              <tr>
                <td colspan="6" class="text-center text-secondary">èª­ã¿è¾¼ã¿ä¸­...</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/**
 * ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã®å‡¦ç†
 */
const Menu = {
  /**
   * åˆæœŸåŒ–
   */
  init: function() {
    console.log('Menu.init');
    this.loadSummary();
    this.loadRecentVisits();

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’è¡¨ç¤º
    const userNameEl = document.getElementById('menu-user-name');
    const headerUserName = document.getElementById('current-user-name');
    if (userNameEl && headerUserName) {
      userNameEl.textContent = headerUserName.textContent.replace(' æ§˜', '');
    }
  },

  /**
   * ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
   */
  refreshSummary: function() {
    this.loadSummary();
    this.loadRecentVisits();
  },

  /**
   * ã‚µãƒãƒªãƒ¼æƒ…å ±ã‚’èª­ã¿è¾¼ã¿
   */
  loadSummary: function() {
    const self = this;

    google.script.run
      .withSuccessHandler(function(data) {
        self.renderSummary(data);
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load summary:', error);
        self.renderSummary({ todayVisits: 0, pendingInput: 0, overdue: 0 });
      })
      .getDashboardSummary();
  },

  /**
   * ã‚µãƒãƒªãƒ¼ã‚’æç”»
   * @param {Object} data - ã‚µãƒãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿
   */
  renderSummary: function(data) {
    document.getElementById('summary-today-visits').textContent =
      (data.todayVisits || 0) + 'å';
    document.getElementById('summary-pending-input').textContent =
      (data.pendingInput || 0) + 'ä»¶';
    document.getElementById('summary-overdue-count').textContent =
      (data.overdue || 0) + 'ä»¶';

    // æœŸé™è¶…éãŒã‚ã‚Œã°è­¦å‘Šã‚¢ã‚¤ã‚³ãƒ³ã‚’è¡¨ç¤º
    const warningEl = document.getElementById('summary-overdue-warning');
    if (data.overdue > 0) {
      warningEl.classList.remove('hidden');
    } else {
      warningEl.classList.add('hidden');
    }
  },

  /**
   * æœ€è¿‘ã®å—è¨ºã‚’èª­ã¿è¾¼ã¿
   */
  loadRecentVisits: function() {
    const self = this;

    google.script.run
      .withSuccessHandler(function(visits) {
        self.renderRecentVisits(visits);
      })
      .withFailureHandler(function(error) {
        console.error('Failed to load recent visits:', error);
        self.renderRecentVisits([]);
      })
      .getRecentVisits(5);
  },

  /**
   * æœ€è¿‘ã®å—è¨ºã‚’æç”»
   * @param {Array} visits - å—è¨ºãƒªã‚¹ãƒˆ
   */
  renderRecentVisits: function(visits) {
    const tbody = document.getElementById('recent-visits-body');
    if (!tbody) return;

    if (!visits || visits.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-secondary">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
      return;
    }

    let html = '';
    visits.forEach(function(visit) {
      html += '<tr class="clickable" onclick="App.navigate(\'detail\', { patientId: \'' + visit.patientId + '\' })">';
      html += '<td>' + App.formatDate(visit.visitDate) + '</td>';
      html += '<td>' + (visit.patientId || '') + '</td>';
      html += '<td>' + (visit.patientName || '') + '</td>';
      html += '<td>' + (visit.examTypeName || '') + '</td>';
      html += '<td>' + App.getJudgmentBadge(visit.overallJudgment) + '</td>';
      html += '<td>' + Menu.getStatusBadge(visit.status) + '</td>';
      html += '</tr>';
    });

    tbody.innerHTML = html;
  },

  /**
   * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ã‚’å–å¾—
   * @param {string} status - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
   * @returns {string} HTML
   */
  getStatusBadge: function(status) {
    let cls = 'alert-info';
    let label = status || '';

    switch (status) {
      case 'INPUTTING':
        cls = 'alert-warning';
        label = 'å…¥åŠ›ä¸­';
        break;
      case 'CONFIRMED':
        cls = 'alert-success';
        label = 'ç¢ºå®š';
        break;
      case 'REPORTED':
        cls = 'alert-info';
        label = 'å ±å‘Šæ¸ˆ';
        break;
    }

    return '<span style="padding: 2px 8px; border-radius: 4px; font-size: 12px; ' +
           'background-color: var(--color-' + cls.replace('alert-', '') + '); color: white;">' +
           label + '</span>';
  }
};
</script>
